

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>valis.slide_io &mdash; valis &#34;1.2.0&#34;
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=784e175d"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >

          
          
          <a href="../../index.html">
            
              <img src="https://github.com/MathOnco/valis/raw/main/docs/_images/valis_logo_black_no_bg.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../registration.html">Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slide_io.html">Slide I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Image pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_detectors.html">Feature detectors and descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_matcher.html">Feature matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../affine_optimizer.html">Affine optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../micro_rigid_registrar.html">Micro-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../non_rigid_registrars.html">Non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_rigid.html">Serial rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serial_non_rigid.html">Serial non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viz.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">valis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">valis.slide_io</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for valis.slide_io</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Methods and classes to read and write slides in the .ome.tiff format</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">kornia</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">transform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvips</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pqdm.threads</span><span class="w"> </span><span class="kn">import</span> <span class="n">pqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statistics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mode</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">elementTree</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ome_types</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jpype</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aicspylibczi</span><span class="w"> </span><span class="kn">import</span> <span class="n">CziFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scyjava</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">difflib</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_close_matches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">colorama</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">valtils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">slide_tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">warp_tools</span>


<span class="n">pyvips</span><span class="o">.</span><span class="n">cache_set_max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">CMAP_AUTO</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">str: Default argument to get channel colors.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">DEFAULT_COMPRESSION</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">ForeignTiffCompression</span><span class="o">.</span><span class="n">DEFLATE</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Default tiff compression method</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">MAX_TILE_SIZE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span>
<span class="sd">&quot;&quot;&quot;int: maximum tile used to read or write images&quot;&quot;&quot;</span>

<span class="n">BF_RDR</span> <span class="o">=</span> <span class="s2">&quot;bioformats&quot;</span>
<span class="sd">&quot;&quot;&quot;str: Name of Bioformats reader.&quot;&quot;&quot;</span>

<span class="n">VIPS_RDR</span> <span class="o">=</span> <span class="s2">&quot;libvips&quot;</span>
<span class="sd">&quot;&quot;&quot;str: Name of pyvips reader&quot;&quot;&quot;</span>

<span class="n">OPENSLIDE_RDR</span> <span class="o">=</span> <span class="s2">&quot;openslide&quot;</span>
<span class="sd">&quot;&quot;&quot;str: Name of OpenSlide reader&quot;&quot;&quot;</span>

<span class="n">IMG_RDR</span> <span class="o">=</span> <span class="s2">&quot;skimage&quot;</span>
<span class="sd">&quot;&quot;&quot;str: Name of image reader&quot;&quot;&quot;</span>

<span class="n">PIXEL_UNIT</span> <span class="o">=</span> <span class="s2">&quot;pixel&quot;</span>
<span class="sd">&quot;&quot;&quot;str: Physical unit when the unit can&#39;t be found in the metadata&quot;&quot;&quot;</span>

<span class="n">MICRON_UNIT</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00B5</span><span class="s1">m&#39;</span>
<span class="sd">&quot;&quot;&quot;str: Phyiscal unit for micron/micrometers&quot;&quot;&quot;</span>

<span class="n">ALL_OPENSLIDE_READABLE_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.svs&quot;</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.vms&quot;</span><span class="p">,</span> <span class="s2">&quot;.vmu&quot;</span><span class="p">,</span> <span class="s2">&quot;.ndpi&quot;</span><span class="p">,</span> <span class="s2">&quot;.scn&quot;</span><span class="p">,</span> <span class="s2">&quot;.mrxs&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.svslide&quot;</span><span class="p">,</span> <span class="s2">&quot;.bif&quot;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;list: File extensions that OpenSlide can read&quot;&quot;&quot;</span>


<span class="c1"># VIPS_READABLE_FORMATS = [&quot;.jpg&quot;, &quot;.jpeg&quot;, &quot;.jpe&quot;, &quot;.jif&quot;, &quot;.jfif&quot;, &quot;.jfi&quot;,</span>
<span class="c1">#                            &quot;.tif&quot;, &quot;.tiff&quot;, &quot;.png&quot;, &quot;.webp&quot;, &quot;.heif&quot;, &quot;.heifs&quot;,</span>
<span class="c1">#                            &quot;.heic&quot;, &quot;.heics&quot;, &quot;.avci&quot;, &quot;.avcs&quot;, &quot;.avif&quot;, &quot;.hif&quot;, &quot;.avif&quot;,</span>
<span class="c1">#                            &quot;.fits&quot;, &quot;.fit&quot;, &quot;.fts&quot;, &quot;.exr&quot;, &quot;.pdf&quot;, &quot;.svg&quot;, &quot;.hdr&quot;,</span>
<span class="c1">#                            &quot;.pbm&quot;, &quot;.pgm&quot;, &quot;.ppm&quot;, &quot;.pfm&quot;,</span>
<span class="c1">#                            &quot;.csv&quot;, &quot;.gif&quot;, &quot;.img&quot;, &quot;.vips&quot;,</span>
<span class="c1">#                            &quot;.nii&quot;, &quot;.nii.gz&quot;,</span>
<span class="c1">#                            &quot;.dzi&quot; &quot;.xml&quot;, &quot;.dcm&quot;, &quot;.ome.tiff&quot;, &quot;.ome.tif&quot;]</span>

<span class="n">VIPS_READABLE_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pyvips</span><span class="o">.</span><span class="n">get_suffixes</span><span class="p">(),</span> <span class="o">*</span><span class="n">ALL_OPENSLIDE_READABLE_FORMATS</span><span class="p">,</span> <span class="s2">&quot;.ome.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.ome.tif&quot;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;list: File extensions that libvips can read. See https://github.com/libvips/libvips</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">VIPS_RGB_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">pyvips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Interpretation</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;list: List of libvips rgb formats</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">BF_FORMAT_F</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;data/bf_formats.txt&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">read_bf_formats</span><span class="p">():</span>
    <span class="n">bf_formats</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">BF_FORMAT_F</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bf_formats</span>


<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">BF_FORMAT_F</span><span class="p">):</span>
    <span class="n">BF_READABLE_FORMATS</span> <span class="o">=</span> <span class="n">read_bf_formats</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">BF_READABLE_FORMATS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;list: File extensions that Bioformats can read.</span>
<span class="sd">   Filled in after initializing JVM&quot;&quot;&quot;</span>

<span class="n">ALL_READABLE_FORMATS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="o">*</span><span class="n">VIPS_READABLE_FORMATS</span><span class="p">,</span> <span class="o">*</span><span class="n">BF_READABLE_FORMATS</span><span class="p">]))</span>
<span class="n">OPENSLIDE_ONLY</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;list: File extensions that OpenSlide can read but Bioformats can&#39;t.</span>
<span class="sd">   Filled in after initializingJVM&quot;&quot;&quot;</span>

<span class="n">FormatTools</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;Bioformats FormatTools.</span>
<span class="sd">   Created after initializing JVM&quot;&quot;&quot;</span>

<span class="n">BF_UNIT</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;Bioformats UNITS.</span>
<span class="sd">   Created after initializing JVM.&quot;&quot;&quot;</span>

<span class="n">BF_MICROMETER</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;Bioformats Unit mircometer object.</span>
<span class="sd">   Created after initializing JVM.&quot;&quot;&quot;</span>

<span class="n">ome</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;Bioformats ome from bioforamts_jar.</span>
<span class="sd">   Created after initializing JVM.&quot;&quot;&quot;</span>

<span class="n">loci</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;Bioformats loci from bioforamts_jar.</span>
<span class="sd">   Created after initializing JVM.&quot;&quot;&quot;</span>

<span class="n">OME_TYPES_PARSER</span> <span class="o">=</span> <span class="s2">&quot;lxml&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">NOTE: Commented out block is how to use boformats with javabrdige.</span>
<span class="sd">However, on conda, javabridge isn&#39;t available for python 3.9.</span>
<span class="sd">If using, remember to put bftools/bioformats_package.jar in the</span>
<span class="sd">source directory.</span>

<span class="sd">Keeping the code just in case need to use javabridge again.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Bioformats + Javabridge #</span>
<span class="c1">#---------------------------------------#</span>
<span class="c1">#</span>
<span class="c1"># try:</span>
<span class="c1">#     bf_jar = os.path.join(pathlib.Path(__file__).parent, &quot;bftools/bioformats_package.jar&quot;)</span>
<span class="c1"># except Exception:</span>
<span class="c1">#     # Running interactively</span>
<span class="c1">#     bf_jar = os.path.join(os.getcwd(), &quot;bftools/bioformats_package.jar&quot;)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def init_jvm_javabridge():</span>
<span class="c1">#     &quot;&quot;&quot;Initialize JVM for BioFormats</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     if javabridge.get_env() is None:</span>
<span class="c1">#</span>
<span class="c1">#         all_jars = javabridge.JARS + [bf_jar]</span>
<span class="c1">#         javabridge.start_vm(class_path=all_jars, max_heap_size=&quot;10G&quot;, run_headless=True)</span>
<span class="c1">#</span>
<span class="c1">#         myloglevel = &quot;ERROR&quot;</span>
<span class="c1">#         rootLoggerName = javabridge.get_static_field(&quot;org/slf4j/Logger&quot;, &quot;ROOT_LOGGER_NAME&quot;, &quot;Ljava/lang/String;&quot;)</span>
<span class="c1">#         rootLogger = javabridge.static_call(&quot;org/slf4j/LoggerFactory&quot;, &quot;getLogger&quot;,</span>
<span class="c1">#                                             &quot;(Ljava/lang/String;)Lorg/slf4j/Logger;&quot;, rootLoggerName)</span>
<span class="c1">#         logLevel = javabridge.get_static_field(&quot;ch/qos/logback/classic/Level&quot;, myloglevel, &quot;Lch/qos/logback/classic/Level;&quot;)</span>
<span class="c1">#         javabridge.call(rootLogger, &quot;setLevel&quot;, &quot;(Lch/qos/logback/classic/Level;)V&quot;, logLevel)</span>
<span class="c1">#</span>
<span class="c1">#         msg = &quot;JVM has been initialize. Be sure to call valis.kill_jvm() or slide_io.kill_jvm() at the end of your script&quot;</span>
<span class="c1">#         valtils.print_warning(msg, warning_type=None, rgb=valtils.Fore.GREEN)</span>
<span class="c1">#</span>
<span class="c1">#         # Fill in global variables that can only be created after initializing the JVM</span>
<span class="c1">#</span>
<span class="c1">#         global FormatTools</span>
<span class="c1">#         global BF_UNIT</span>
<span class="c1">#         global BF_MICROMETER</span>
<span class="c1">#         global BF_READABLE_FORMATS</span>
<span class="c1">#         global OPENSLIDE_ONLY</span>
<span class="c1">#</span>
<span class="c1">#         FormatTools = javabridge.JClassWrapper(&quot;loci.formats.FormatTools&quot;)</span>
<span class="c1">#         BF_UNIT = javabridge.JClassWrapper(&quot;ome.units.UNITS&quot;)</span>
<span class="c1">#         BF_MICROMETER = BF_UNIT.MICROMETER</span>
<span class="c1">#         BF_READABLE_FORMATS = get_bf_readable_formats_javabridge()</span>
<span class="c1">#         OPENSLIDE_ONLY = list(set(ALL_OPENSLIDE_READABLE_FORMATS).difference(set(BF_READABLE_FORMATS)))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def kill_jvm_javabridge():</span>
<span class="c1">#     &quot;&quot;&quot;Kill JVM for BioFormats</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     javabridge.kill_vm()</span>
<span class="c1">#     msg = &quot;JVM has been killed. If this was due to an error, then a new Python session will need to be started&quot;</span>
<span class="c1">#     valtils.print_warning(msg, warning_type=None, rgb=valtils.Fore.GREEN)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def get_bf_readable_formats_javabridge():</span>
<span class="c1">#     &quot;&quot;&quot;Get extensions of formats that BioFormats can read</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if javabridge.get_env() is None:</span>
<span class="c1">#         init_jvm_javabridge()</span>
<span class="c1">#</span>
<span class="c1">#     env = javabridge.get_env()</span>
<span class="c1">#     base_reader = javabridge.make_instance(&#39;loci/formats/ImageReader&#39;, &#39;()V&#39;)</span>
<span class="c1">#     readers = javabridge.jutil.call(base_reader, &#39;getReaders&#39;,</span>
<span class="c1">#                                     &#39;()[Lloci/formats/IFormatReader;&#39;)</span>
<span class="c1">#     all_readers = env.get_object_array_elements(readers)</span>
<span class="c1">#     readable_formats = []</span>
<span class="c1">#     f_append = readable_formats.append</span>
<span class="c1">#     for format_reader in all_readers:</span>
<span class="c1">#         j_suffixes = javabridge.get_env().get_object_array_elements(</span>
<span class="c1">#             javabridge.jutil.call(</span>
<span class="c1">#                 format_reader, &#39;getSuffixes&#39;,</span>
<span class="c1">#                 &#39;()[Ljava/lang/String;&#39;))</span>
<span class="c1">#</span>
<span class="c1">#         for js in j_suffixes:</span>
<span class="c1">#             suffix = javabridge.to_string(js)</span>
<span class="c1">#             if len(suffix) &gt; 0:</span>
<span class="c1">#                 f_append(&quot;.&quot; + suffix)</span>
<span class="c1">#</span>
<span class="c1">#     javabridge.jutil.call(base_reader, &#39;close&#39;, &#39;()V&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     return readable_formats</span>
<span class="c1">#---------------------------------------#</span>

<span class="c1"># Bioformats/scyjava + Jpype #</span>
<span class="c1">#--------------------#</span>


<div class="viewcode-block" id="init_jvm">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.init_jvm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_jvm</span><span class="p">(</span><span class="n">jar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mem_gb</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize JVM for BioFormats</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mem_gb : int</span>
<span class="sd">        Amount of memory, in GB, for JVM</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">jpype</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">jpype</span><span class="o">.</span><span class="n">isJVMStarted</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">FormatTools</span>
        <span class="k">global</span> <span class="n">BF_MICROMETER</span>
        <span class="k">global</span> <span class="n">OPENSLIDE_ONLY</span>
        <span class="k">global</span> <span class="n">BF_READABLE_FORMATS</span>
        <span class="k">global</span> <span class="n">ome</span>
        <span class="k">global</span> <span class="n">loci</span>

        <span class="k">if</span> <span class="n">jar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Check if jar is bundled with source code, like in a Docker image</span>
            <span class="c1"># Can use instead of using maven to download, which requires an unblocked connection</span>
            <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="n">local_bf_jar</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s2">&quot;bioformats_package.jar&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_bf_jar</span><span class="p">):</span>
                <span class="n">jar</span> <span class="o">=</span> <span class="n">local_bf_jar</span>

        <span class="k">if</span> <span class="n">jar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jpype</span><span class="o">.</span><span class="n">addClassPath</span><span class="p">(</span><span class="n">jar</span><span class="p">)</span>
            <span class="n">jpype</span><span class="o">.</span><span class="n">startJVM</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-Djava.awt.headless=true -Xmx</span><span class="si">{</span><span class="n">mem_gb</span><span class="si">}</span><span class="s2">G&quot;</span><span class="p">,</span> <span class="n">classpath</span><span class="o">=</span><span class="n">jar</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">scyjava</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">endpoints</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;ome:formats-gpl&#39;</span><span class="p">,</span> <span class="s1">&#39;ome:jxrlib-all&#39;</span><span class="p">])</span>
            <span class="n">scyjava</span><span class="o">.</span><span class="n">start_jvm</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;-Xmx</span><span class="si">{</span><span class="n">mem_gb</span><span class="si">}</span><span class="s2">G&quot;</span><span class="p">])</span>

        <span class="n">loci</span> <span class="o">=</span> <span class="n">jpype</span><span class="o">.</span><span class="n">JPackage</span><span class="p">(</span><span class="s2">&quot;loci&quot;</span><span class="p">)</span>
        <span class="n">ome</span> <span class="o">=</span> <span class="n">jpype</span><span class="o">.</span><span class="n">JPackage</span><span class="p">(</span><span class="s2">&quot;ome&quot;</span><span class="p">)</span>
        <span class="n">loci</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">DebugTools</span><span class="o">.</span><span class="n">setRootLevel</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>

        <span class="n">FormatTools</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">FormatTools</span>
        <span class="n">BF_MICROMETER</span> <span class="o">=</span> <span class="n">ome</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">UNITS</span><span class="o">.</span><span class="n">MICROMETER</span>
        <span class="n">BF_READABLE_FORMATS</span> <span class="o">=</span> <span class="n">get_bf_readable_formats</span><span class="p">()</span>
        <span class="n">OPENSLIDE_ONLY</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ALL_OPENSLIDE_READABLE_FORMATS</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">BF_READABLE_FORMATS</span><span class="p">)))</span>

        <span class="c1"># Save formats in case using a different version of Bioformats</span>
        <span class="n">bf_data_parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">BF_FORMAT_F</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">bf_data_parent_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">BF_FORMAT_F</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">BF_READABLE_FORMATS</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JVM has been initialized. &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;Be sure to call registration.kill_jvm() &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;or slide_io.kill_jvm() at the end of your script.&quot;</span><span class="p">)</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">warning_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">valtils</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span></div>



<div class="viewcode-block" id="kill_jvm">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.kill_jvm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">kill_jvm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Kill JVM for BioFormats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scyjava</span><span class="o">.</span><span class="n">shutdown_jvm</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;JVM has been killed. If this was due to an error, then a new Python session will need to be started&quot;</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">warning_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">valtils</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_bioformats_version</span><span class="p">():</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">FormatTools</span><span class="o">.</span><span class="n">VERSION</span>

    <span class="k">return</span> <span class="n">v</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_bf_readable_formats</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get extensions of formats that BioFormats can read</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    readable_formats : list of str</span>
<span class="sd">        List of formats that can be read by Bioformats</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">jpype</span><span class="o">.</span><span class="n">isJVMStarted</span><span class="p">():</span>
        <span class="n">init_jvm</span><span class="p">()</span>

    <span class="n">baseReader</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">()</span>
    <span class="n">readers</span> <span class="o">=</span> <span class="n">baseReader</span><span class="o">.</span><span class="n">getReaders</span><span class="p">()</span>
    <span class="n">read_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">readers</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
    <span class="n">readable_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">readers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getSuffixes</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">read_range</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">baseReader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">readable_formats</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bf_to_numpy_dtype</span><span class="p">(</span><span class="n">bf_pixel_type</span><span class="p">,</span> <span class="n">little_endian</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get numpy equivalent of the bioformats pixel type</span>

<span class="sd">    Adapted from the python-bioformats package</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bf_pixel_type : int</span>
<span class="sd">        Integer indicating the Bioformats pixel type</span>

<span class="sd">    little_endian : bool</span>
<span class="sd">        Whether or not the image is little endian</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        Numpy dtype</span>

<span class="sd">    scale : int</span>
<span class="sd">        Maximum value of `dtype`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">INT8</span><span class="p">:</span>
        <span class="c1"># FormatTools.INT8 = 0</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">UINT8</span><span class="p">:</span>
        <span class="c1"># FormatTools.UINT8 = 1</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">UINT16</span><span class="p">:</span>
        <span class="c1"># FormatTools.UINT16 = 3</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;u2&#39;</span> <span class="k">if</span> <span class="n">little_endian</span> <span class="k">else</span> <span class="s1">&#39;&gt;u2&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">65535</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">INT16</span><span class="p">:</span>
        <span class="c1"># FormatTools.INT16 = 2</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;i2&#39;</span> <span class="k">if</span> <span class="n">little_endian</span> <span class="k">else</span> <span class="s1">&#39;&gt;i2&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">65535</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">UINT32</span><span class="p">:</span>
        <span class="c1"># FormatTools.UINT32 = 5</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;u4&#39;</span> <span class="k">if</span> <span class="n">little_endian</span> <span class="k">else</span> <span class="s1">&#39;&gt;u4&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">INT32</span><span class="p">:</span>
        <span class="c1"># FormatTools.INT32 = 4</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;i4&#39;</span> <span class="k">if</span> <span class="n">little_endian</span> <span class="k">else</span> <span class="s1">&#39;&gt;i4&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">:</span>
        <span class="c1"># FormatTools.FLOAT = 6</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;f4&#39;</span> <span class="k">if</span> <span class="n">little_endian</span> <span class="k">else</span> <span class="s1">&#39;&gt;f4&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">bf_pixel_type</span> <span class="o">==</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">:</span>
        <span class="c1"># FormatTools.DOUBLE = 7</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;f8&#39;</span> <span class="k">if</span> <span class="n">little_endian</span> <span class="k">else</span> <span class="s1">&#39;&gt;f8&#39;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">scale</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vips2bf_dtype</span><span class="p">(</span><span class="n">vips_format</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get bioformats equivalent of the pyvips pixel type</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vips_format : str</span>
<span class="sd">        Format of the pyvips.Image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bf_dtype : str</span>
<span class="sd">        String format of Bioformats datatype</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">VIPS_FORMAT_NUMPY_DTYPE</span><span class="p">[</span><span class="n">vips_format</span><span class="p">]</span>
    <span class="n">bf_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_BF_DTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">np_dtype</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">bf_dtype</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bf2vips_dtype</span><span class="p">(</span><span class="n">bf_dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get bioformats equivalent of the pyvips pixel type</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bf_dtype : str</span>
<span class="sd">        String format of Bioformats datatype</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vips_format : str</span>
<span class="sd">        Format of the pyvips.Image</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">np_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">BF_FORMAT_NUMPY_DTYPE</span><span class="p">[</span><span class="n">bf_dtype</span><span class="p">]</span>
    <span class="n">vips_format</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_VIPS_DTYPE</span><span class="p">[</span><span class="n">np_type</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">vips_format</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_czi_jpegxr</span><span class="p">(</span><span class="n">src_f</span><span class="p">):</span>
    <span class="n">f_extension</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f_extension</span> <span class="o">!=</span> <span class="s2">&quot;.czi&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">czi</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">is_czi_jpgxr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">comp_tree</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//OriginalCompressionMethod&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_tree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">is_czi_jpgxr</span> <span class="o">=</span> <span class="n">comp_tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;jpgxr&quot;</span>

    <span class="k">return</span> <span class="n">is_czi_jpgxr</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_to_use_openslide</span><span class="p">(</span><span class="n">src_f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if OpenSlide can be used to read the slide</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_f : str</span>
<span class="sd">        Path to slide</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    use_openslide : bool</span>
<span class="sd">        Whether or not OpenSlide can be used to read the slide.</span>
<span class="sd">        This can happen if the file format is not readable by</span>
<span class="sd">        OpenSlide, or if pyvips wasn&#39;t installed with OpenSlide</span>
<span class="sd">        support.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">use_openslide</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">img_format</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img_format</span> <span class="ow">in</span> <span class="n">ALL_OPENSLIDE_READABLE_FORMATS</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
            <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;openslide.level-count&quot;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
                <span class="n">use_openslide</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">use_openslide</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_ome_obj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get ome_types.model.ome.OME object</span>

<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    x: str</span>
<span class="sd">        Either OME-XML or path to ome.tiff</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ome_obj : ome_types.model.ome.OME</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">is_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ome_obj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to use ome-types</span>
        <span class="k">if</span> <span class="n">is_file</span><span class="p">:</span>
            <span class="n">ome_fxn</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">from_tiff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ome_fxn</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">from_xml</span>

        <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">ome_fxn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_obj</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">ome_fxn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">OME_TYPES_PARSER</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Sometimes the image description found by `ome_types.from_tiff`</span>
        <span class="c1"># does not contain the ome-xml. Seems to be the case for ImageJ exports, at least</span>
        <span class="k">if</span> <span class="n">is_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bf_rdr</span><span class="p">,</span> <span class="n">bf_meta</span> <span class="o">=</span> <span class="n">get_bioformats_reader_and_meta</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">meta_xml</span> <span class="o">=</span> <span class="n">bf_meta</span><span class="o">.</span><span class="n">dumpXML</span><span class="p">()</span>
                <span class="n">meta_xml</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta_xml</span><span class="p">)</span>
                <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">from_xml</span><span class="p">(</span><span class="n">meta_xml</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_obj</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">from_xml</span><span class="p">(</span><span class="n">meta_xml</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">OME_TYPES_PARSER</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ome_fxn</span> <span class="o">==</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">from_tiff</span><span class="p">:</span>
                    <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get OME-XML for image </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, due to the following error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get OME-XML, due to the following error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ome_obj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_is_ome</span><span class="p">(</span><span class="n">src_f</span><span class="p">):</span>
    <span class="n">is_ome</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.ome&quot;</span><span class="p">,</span> <span class="n">src_f</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.tif*&quot;</span><span class="p">,</span> <span class="n">src_f</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_ome</span><span class="p">:</span>
        <span class="c1"># Verify that image is valid ome.tiff</span>
        <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ome_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ome</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">is_ome</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_to_use_vips</span><span class="p">(</span><span class="n">src_f</span><span class="p">):</span>

    <span class="n">f_extension</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">can_use_pyvips</span> <span class="o">=</span> <span class="n">f_extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">VIPS_READABLE_FORMATS</span>

    <span class="k">return</span> <span class="n">can_use_pyvips</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_to_use_bioformats</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if bioformats can be used to read metadata and/or image</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_format</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">use_bf</span> <span class="o">=</span> <span class="n">img_format</span> <span class="ow">in</span> <span class="n">BF_READABLE_FORMATS</span>

    <span class="n">can_get_metadata</span> <span class="o">=</span> <span class="n">use_bf</span>
    <span class="n">can_read_img</span> <span class="o">=</span> <span class="n">use_bf</span>
    <span class="k">if</span> <span class="n">use_bf</span><span class="p">:</span>

        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error using Bioformats to read </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">src_f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">. Will try to use a different reader&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to get metadata</span>
            <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">can_get_metadata</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">can_read_img</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">can_get_metadata</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Can get metadata, try reading small slice</span>
            <span class="n">test_read_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">bf_reader</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">test_read_level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="n">can_read_img</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">can_get_metadata</span><span class="p">,</span> <span class="n">can_read_img</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_flattened_pyramid_tiff</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">check_with_bf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if a tiff is a flattened pyramid</span>

<span class="sd">    Determines if a slide is pyramid where each page/plane is a channel</span>
<span class="sd">    in the pyramid. An example would be one where the plane dimensions are</span>
<span class="sd">    something like</span>
<span class="sd">    [(600, 600), (600, 600), (600, 600), (300, 300), (300, 300), (300, 300)]</span>
<span class="sd">    for a 3 channel image with  2  pyramid levels. It seems that bioformats</span>
<span class="sd">    does not recognize these as pyramid images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_f : str</span>
<span class="sd">        Path to slide</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    is_flattended_pyramid : bool</span>
<span class="sd">        Whether  or not the slide is a flattened pyramid</span>

<span class="sd">    can_use_bf : bool</span>
<span class="sd">        Whether or not Bioformats will read the slide in the same way</span>

<span class="sd">    slide_dimensions : ndarray</span>
<span class="sd">        Dimensions (width, height) for each level in the  pyramid</span>

<span class="sd">    levels_start_idx : ndarray</span>
<span class="sd">        The indices indicating which pages/planes start the next</span>
<span class="sd">        pyramid level</span>

<span class="sd">    n_channels : int</span>
<span class="sd">        Number of channels in the slide</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vips_img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>

    <span class="n">is_flattended_pyramid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">can_use_bf</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;n-pages&#39;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
        <span class="n">n_pages</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n-pages&quot;</span><span class="p">)</span>
        <span class="n">all_areas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_n_channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">level_starts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_area</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pages</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error at page </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span>
            <span class="n">nc</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">bands</span>
            <span class="n">img_area</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">nc</span>

            <span class="n">all_areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_area</span><span class="p">)</span>
            <span class="n">all_dims</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
            <span class="n">all_n_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prev_area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prev_area</span> <span class="o">=</span> <span class="n">img_area</span>
                <span class="n">level_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prev_area</span> <span class="o">!=</span> <span class="n">img_area</span><span class="p">:</span>
                    <span class="n">level_starts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">prev_area</span> <span class="o">=</span> <span class="n">img_area</span>

        <span class="n">level_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">level_starts</span><span class="p">)</span>
        <span class="n">area_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">all_areas</span><span class="p">)</span>
        <span class="n">most_common_channel_count</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">all_n_channels</span><span class="p">)</span>

        <span class="n">unique_areas</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_areas</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_zero_diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">area_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">most_common_channel_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n_zero_diff</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_areas</span><span class="p">):</span>
            <span class="n">is_flattended_pyramid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">is_flattended_pyramid</span><span class="p">:</span>
            <span class="n">nchannels_per_each_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">level_starts</span><span class="p">)</span>
            <span class="n">last_level_channel_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_n_channels</span><span class="p">[</span><span class="n">level_starts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:])</span>
            <span class="n">nchannels_per_each_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">nchannels_per_each_level</span><span class="p">,</span>
                                                  <span class="n">last_level_channel_count</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">last_level_channel_count</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">nchannels_per_each_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># last level is probably a thumbnail</span>
                <span class="n">nchannels_per_each_level</span> <span class="o">=</span> <span class="n">nchannels_per_each_level</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n_channels</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">nchannels_per_each_level</span><span class="p">)</span>
            <span class="n">levels_start_idx</span> <span class="o">=</span> <span class="n">level_starts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nchannels_per_each_level</span><span class="o">==</span><span class="n">n_channels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">slide_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_dims</span><span class="p">)[</span><span class="n">levels_start_idx</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">slide_dimensions</span> <span class="o">=</span> <span class="n">all_dims</span>
            <span class="n">levels_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_dimensions</span><span class="p">))</span>
            <span class="n">n_channels</span> <span class="o">=</span> <span class="n">most_common_channel_count</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">is_flattended_pyramid</span><span class="p">,</span> <span class="n">can_use_bf</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="c1"># Now check if Bioformats reads it similarly #</span>
    <span class="k">if</span> <span class="n">check_with_bf</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
            <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">bf_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">)</span>
        <span class="n">bf_channels</span> <span class="o">=</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span>
        <span class="n">can_use_bf</span> <span class="o">=</span> <span class="n">bf_levels</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide_dimensions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bf_channels</span> <span class="o">==</span> <span class="n">n_channels</span>

    <span class="k">return</span> <span class="n">is_flattended_pyramid</span><span class="p">,</span> <span class="n">can_use_bf</span><span class="p">,</span> <span class="n">slide_dimensions</span><span class="p">,</span> <span class="n">levels_start_idx</span><span class="p">,</span> <span class="n">n_channels</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_xml_img_match</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Make sure that provided xml and image match.</span>
<span class="sd">    If there is a mismatch (i.e. channel number), the values in the image take precedence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_obj</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ome_img</span> <span class="o">=</span> <span class="n">ome_obj</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">pixels</span>
        <span class="n">ome_nc</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_c</span>
        <span class="n">ome_nt</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_t</span>
        <span class="n">ome_nz</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_z</span>
        <span class="n">ome_size_x</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_x</span>
        <span class="n">ome_size_y</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_y</span>
        <span class="n">ome_dtype</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">total_pages</span> <span class="o">=</span> <span class="n">ome_nc</span><span class="o">*</span><span class="n">ome_nt</span><span class="o">*</span><span class="n">ome_nz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ome-xml for </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not contain any metadata for any images&quot;</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">ome_nc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ome_nt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ome_nz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ome_size_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ome_size_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ome_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span>

    <span class="n">vips_nc</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span>
    <span class="n">vips_size_x</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">width</span>
    <span class="n">vips_size_y</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">height</span>
    <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">VIPS_FORMAT_NUMPY_DTYPE</span><span class="p">[</span><span class="n">vips_img</span><span class="o">.</span><span class="n">format</span><span class="p">]</span>
    <span class="n">vips_bf_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_BF_DTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">np_dtype</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">total_pages</span> <span class="o">!=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, the ome-xml states there should be </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2"> pages, but there is/are </span><span class="si">{</span><span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span><span class="si">}</span><span class="s2"> pages in the image&quot;</span><span class="p">,</span>
                   <span class="sa">f</span><span class="s2">&quot;Assuming that all pages are channels (not time points or Z-axes), so updating the metadata to have </span><span class="si">{</span><span class="n">total_pages</span><span class="si">}</span><span class="s2"> channels&quot;</span><span class="p">)</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">vips_nc</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">n_t</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">n_z</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ome_nc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ome_size_x</span> <span class="o">!=</span> <span class="n">vips_size_x</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, the ome-xml states the width should be </span><span class="si">{</span><span class="n">ome_size_x</span><span class="si">}</span><span class="s2">, but the image has a width of </span><span class="si">{</span><span class="n">vips_size_x</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">ome_size_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ome_size_y</span> <span class="o">!=</span> <span class="n">vips_size_y</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, the ome-xml states the height should be </span><span class="si">{</span><span class="n">ome_size_y</span><span class="si">}</span><span class="s2">, but the image has a width of </span><span class="si">{</span><span class="n">vips_size_y</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">ome_size_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ome_dtype</span> <span class="o">!=</span> <span class="n">vips_bf_dtype</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, the ome-xml states the image type should be </span><span class="si">{</span><span class="n">ome_dtype</span><span class="si">}</span><span class="s2">, but the image has type of </span><span class="si">{</span><span class="n">vips_bf_dtype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="n">vips_bf_dtype</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">bf_pixel_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">BF_DTYPE_PIXEL_TYPE</span><span class="p">[</span><span class="n">vips_bf_dtype</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ome_dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metadata</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_bioformats_reader_and_meta</span><span class="p">(</span><span class="n">src_f</span><span class="p">):</span>
    <span class="n">init_jvm</span><span class="p">()</span>
    <span class="n">rdr</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">()</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">ServiceFactory</span><span class="p">()</span>
    <span class="n">OMEXMLService_class</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">OMEXMLService</span>

    <span class="n">service</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">getInstance</span><span class="p">(</span><span class="n">OMEXMLService_class</span><span class="p">)</span>
    <span class="n">ome_meta</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">createOMEXMLMetadata</span><span class="p">()</span>
    <span class="n">rdr</span><span class="o">.</span><span class="n">setMetadataStore</span><span class="p">(</span><span class="n">ome_meta</span><span class="p">)</span>
    <span class="n">rdr</span><span class="o">.</span><span class="n">setFlattenedResolutions</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rdr</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getMetadataStore</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span>


<span class="k">def</span><span class="w"> </span><span class="nf">metadata_from_xml</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use ome-types to extract metadata from xml.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ome_info</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
    <span class="n">ome_img</span> <span class="o">=</span> <span class="n">ome_info</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">big_endian</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">big_endian</span> <span class="o">==</span> <span class="kc">False</span>

    <span class="n">has_channel_info</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">has_channel_info</span><span class="p">:</span>
        <span class="n">samples_per_pixel</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">samples_per_pixel</span>
        <span class="k">if</span> <span class="n">samples_per_pixel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples_per_pixel</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">size_c</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="n">samples_per_pixel</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> \
            <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;uint8&#39;</span> <span class="ow">and</span> \
            <span class="nb">len</span><span class="p">(</span><span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No channel info, so guess based on image shape and datatype</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;uint8&#39;</span> <span class="ow">and</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">size_c</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="p">(</span><span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_x</span><span class="p">,</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_y</span><span class="p">,</span> <span class="n">MICRON_UNIT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PIXEL_UNIT</span><span class="p">)</span>

    <span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">size_c</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">n_z</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">size_z</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">n_t</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">size_t</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">original_xml</span> <span class="o">=</span> <span class="n">ome_info</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">bf_pixel_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">BF_DTYPE_PIXEL_TYPE</span><span class="p">[</span><span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_channel_info</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)]</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">check_channel_names</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">src_f</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="n">get_default_channel_names</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">src_f</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metadata</span>


<span class="k">def</span><span class="w"> </span><span class="nf">openslide_desc_2_omexml</span><span class="p">(</span><span class="n">vips_img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get basic metatad using openslide and convert to ome-xml</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;openslide.vendor&quot;</span> <span class="ow">in</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(),</span> <span class="s2">&quot;image does not appear to be openslide metadata&quot;</span>
    <span class="n">img_shape_wh</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">get_shape_xyzct</span><span class="p">(</span><span class="n">shape_wh</span><span class="o">=</span><span class="n">img_shape_wh</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">=</span><span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span><span class="p">)</span>

    <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">VIPS_FORMAT_NUMPY_DTYPE</span><span class="p">[</span><span class="n">vips_img</span><span class="o">.</span><span class="n">format</span><span class="p">]</span>
    <span class="n">bf_datatype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_BF_DTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">np_dtype</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span>

    <span class="n">new_img</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Image:0&quot;</span><span class="p">,</span>
        <span class="n">pixels</span><span class="o">=</span><span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Pixels</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pixels:0&quot;</span><span class="p">,</span>
            <span class="n">size_x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">size_y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">size_z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
            <span class="n">size_c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">size_t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">bf_datatype</span><span class="p">,</span>
            <span class="n">dimension_order</span><span class="o">=</span><span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>
            <span class="n">physical_size_x</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openslide.mpp-x&#39;</span><span class="p">)),</span>
            <span class="n">physical_size_x_unit</span> <span class="o">=</span> <span class="n">MICRON_UNIT</span><span class="p">,</span>
            <span class="n">physical_size_y</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openslide.mpp-y&#39;</span><span class="p">)),</span>
            <span class="n">physical_size_y_unit</span> <span class="o">=</span> <span class="n">MICRON_UNIT</span><span class="p">,</span>
            <span class="n">metadata_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Should always be rgb, but checking anyway</span>
    <span class="n">is_rgb</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">interpretation</span> <span class="ow">in</span> <span class="n">VIPS_RGB_FORMATS</span>
    <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="n">rgb_channel</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;Channel:0:0&#39;</span><span class="p">,</span> <span class="n">samples_per_pixel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgb_channel</span><span class="p">]</span>

    <span class="n">new_ome</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">OME</span><span class="p">()</span>
    <span class="n">new_ome</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_img</span><span class="p">)</span>

    <span class="n">img_xml</span> <span class="o">=</span> <span class="n">new_ome</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">img_xml</span>



<span class="c1"># Read slides #</span>
<div class="viewcode-block" id="MetaData">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.MetaData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MetaData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store slide metadata</span>

<span class="sd">    To be filled in by a SlideReader object</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    name : str</span>
<span class="sd">        Name of slide.</span>

<span class="sd">    series : int</span>
<span class="sd">        Series number.</span>

<span class="sd">    server : str</span>
<span class="sd">        String indicating what was used to read the metadata.</span>

<span class="sd">    slide_dimensions :</span>
<span class="sd">        Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">    is_rgb : bool</span>
<span class="sd">        Whether or not the image is RGB.</span>

<span class="sd">    pixel_physical_size_xyu :</span>
<span class="sd">        Physical size per pixel and the unit.</span>

<span class="sd">    channel_names : list</span>
<span class="sd">        List of channel names. None if image is RGB</span>

<span class="sd">    n_channels : int</span>
<span class="sd">        Number of channels.</span>

<span class="sd">    original_xml : str</span>
<span class="sd">        Xml string created by bio-formats</span>

<span class="sd">    bf_datatype : str</span>
<span class="sd">        String indicating bioformats image datatype</span>

<span class="sd">    optimal_tile_wh : int</span>
<span class="sd">        Tile width and height used to open and/or save image</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MetaData.__init__">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.MetaData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of slide.</span>

<span class="sd">        server : str, optional</span>
<span class="sd">            String indicating what was used to read the metadata.</span>

<span class="sd">        series : int, optional</span>
<span class="sd">            Series number.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_dimensions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_z</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_xml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bf_pixel_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimal_tile_wh</span> <span class="o">=</span> <span class="mi">1024</span></div>
</div>



<div class="viewcode-block" id="SlideReader">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.SlideReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SlideReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read slides and get metadata</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    slide_f : str</span>
<span class="sd">        Path to slide</span>

<span class="sd">    metadata : MetaData</span>
<span class="sd">        MetaData containing some basic metadata about the slide</span>

<span class="sd">    series : int</span>
<span class="sd">        Image series</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SlideReader.__init__">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.SlideReader.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        src_f : str</span>
<span class="sd">            Path to slide</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">src_f</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="SlideReader.slide2vips">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.SlideReader.slide2vips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to pyvips.Image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vips_slide : pyvips.Image</span>
<span class="sd">            An  of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="SlideReader.slide2image">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.SlideReader.slide2image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : ndarray</span>
<span class="sd">            An image of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">guess_image_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Guess if image is </span><span class="si">{</span><span class="n">slide_tools</span><span class="o">.</span><span class="n">IHC_NAME</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">slide_tools</span><span class="o">.</span><span class="n">IF_NAME</span><span class="si">}</span>

<span class="s2">            Brightfield : RGB or uint8 + 3 channels (after removing alpha)</span>
<span class="s2">            Immunofluorescence: != 3 channels and not RGB</span>

<span class="s2">        Returns</span>
<span class="s2">        -------</span>
<span class="s2">        img_type : str</span>
<span class="s2">            Image type</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
            <span class="n">img_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">IHC_NAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">IF_NAME</span>

        <span class="k">return</span> <span class="n">img_type</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scale_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get resolution pyramid level</span>

<span class="sd">        Scale resolution to be for requested pyramid level</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        level_xy_per_px: tuple</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">level_0_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">level_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
        <span class="n">scale_x</span> <span class="o">=</span> <span class="n">level_0_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">level_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scale_y</span> <span class="o">=</span> <span class="n">level_0_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">level_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">level_xy_per_px</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">scale_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">level_xy_per_px</span>

<div class="viewcode-block" id="SlideReader.create_metadata">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.SlideReader.create_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create and fill in a MetaData object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        metadata : MetaData</span>
<span class="sd">            MetaData object containing metadata about slide</span>

<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">matching_channel_idx</span> <span class="o">=</span> <span class="n">channel</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">best_match</span> <span class="o">=</span> <span class="n">get_close_matches</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">cnames</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">matching_channel_idx</span> <span class="o">=</span> <span class="n">cnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">best_match</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">best_match</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot find exact match to channel &#39;</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span><span class="si">}</span><span class="s2">. Using channel </span><span class="si">{</span><span class="n">best_match</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">matching_channel_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find channel &#39;</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot; Available channels are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span><span class="si">}</span><span class="s2">.&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot; Using channel number </span><span class="si">{</span><span class="n">matching_channel_idx</span><span class="si">}</span><span class="s2">, which has name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">channel_names</span><span class="p">[</span><span class="n">matching_channel_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">matching_channel_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">matching_channel_idx</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get channel from slide</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        series  : int</span>
<span class="sd">            Series number</span>

<span class="sd">        channel : str, int</span>
<span class="sd">            Either the name of the channel (string), or the index of the channel (int)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img_channel : ndarray</span>
<span class="sd">            Specified channel sliced from the slide/image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">matching_channel_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_index</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2image</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
        <span class="n">img_channel</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">matching_channel_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">img_channel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if image is RGB</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_rgb : bool</span>
<span class="sd">            Whether or not the image is RGB</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get names of each channel</span>

<span class="sd">        Get list of channel names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        channel_names : list</span>
<span class="sd">            List of channel names</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimensions of slide at all pyramid levels</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slide_dims : ndarray</span>
<span class="sd">            Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pixel_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get resolution of slide</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res_xyu : tuple</span>
<span class="sd">            Physical size per pixel and the unit, e.g. u&#39;\u00B5m&#39;</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            If physical unit is micron, it must be u&#39;\u00B5m&#39;,</span>
<span class="sd">            not mu (u&#39;\u03bcm&#39;) or u.</span>

<span class="sd">        &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="BioFormatsSlideReader">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.BioFormatsSlideReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BioFormatsSlideReader</span><span class="p">(</span><span class="n">SlideReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read slides using BioFormats</span>

<span class="sd">    Uses the packages jpype and bioformats-jar</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        src_f : str</span>
<span class="sd">            Path to slide</span>

<span class="sd">        series : int</span>
<span class="sd">            The series to be read. If `series` is None, the the `series`</span>
<span class="sd">            will be set to the series associated with the largest image.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">init_jvm</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">src_f</span><span class="o">=</span><span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metadata</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">)</span>
            <span class="n">kill_jvm</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_series</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img_areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span><span class="p">]</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img_areas</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_areas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No series provided. &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;Selecting series with largest image, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;which is series </span><span class="si">{</span><span class="n">series</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">warning_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">valtils</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_series</span>

    <span class="n">series</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="o">=</span><span class="n">_get_series</span><span class="p">,</span>
                      <span class="n">fset</span><span class="o">=</span><span class="n">_set_series</span><span class="p">,</span>
                      <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Slide series&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BioFormatsSlideReader.get_tiles_parallel">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.BioFormatsSlideReader.get_tiles_parallel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tiles_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">tile_bbox_list</span><span class="p">,</span> <span class="n">pixel_type</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get tiles to slice from the slide</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_tiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_bbox_list</span><span class="p">)</span>
        <span class="n">tile_array</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_tiles</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">tile2vips_threaded</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
            <span class="n">xywh</span> <span class="o">=</span> <span class="n">tile_bbox_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># javabridge.attach()</span>
            <span class="c1"># jpype.attachThreadToJVM()</span>
            <span class="n">jpype</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">attach</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2image</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">xywh</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="c1"># javabridge.detach()</span>
            <span class="c1"># jpype.detachThreadFromJVM()</span>
            <span class="n">jpype</span><span class="o">.</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

            <span class="n">tile_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">pyvips_interpretation</span><span class="p">)</span>

        <span class="n">n_cpu</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">get_ncpus_available</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_tiles</span><span class="p">),</span> <span class="n">tile2vips_threaded</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_cpu</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;tiles&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tile_array</span></div>


<div class="viewcode-block" id="BioFormatsSlideReader.slide2vips">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.BioFormatsSlideReader.slide2vips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_wh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to pyvips.Image</span>

<span class="sd">        This method uses Bioformats to slice tiles from the slides, and then</span>
<span class="sd">        stitch them together using pyvips.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        series : int, optional</span>
<span class="sd">            Series number. Defaults to 0</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        tile_wh : int, optional</span>
<span class="sd">            Size of tiles used to contstruct `vips_slide`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vips_slide : pyvips.Image</span>
<span class="sd">            An  of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>

        <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bf_objects</span><span class="p">()</span>
        <span class="n">pixel_type</span><span class="p">,</span> <span class="n">drange</span> <span class="o">=</span> <span class="n">bf_to_numpy_dtype</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getPixelType</span><span class="p">(),</span>
                                               <span class="n">rdr</span><span class="o">.</span><span class="n">isLittleEndian</span><span class="p">())</span>

        <span class="n">slide_shape_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">tile_wh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getOptimalTileWidth</span><span class="p">()</span>
        <span class="n">rdr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">tile_wh</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile_wh</span><span class="p">,</span> <span class="n">MAX_TILE_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">slide_shape_wh</span> <span class="o">&lt;</span> <span class="n">tile_wh</span><span class="p">):</span>
            <span class="n">tile_wh</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">slide_shape_wh</span><span class="p">)</span>

        <span class="n">tile_bbox</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_grid_bboxes</span><span class="p">(</span><span class="n">slide_shape_wh</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                               <span class="n">tile_wh</span><span class="p">,</span> <span class="n">tile_wh</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">n_across</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tile_bbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting slide to pyvips image&quot;</span><span class="p">)</span>
        <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">arrayjoin</span><span class="p">(</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">get_tiles_parallel</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">tile_bbox_list</span><span class="o">=</span><span class="n">tile_bbox</span><span class="p">,</span> <span class="n">pixel_type</span><span class="o">=</span><span class="n">pixel_type</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">),</span>
                                  <span class="n">across</span><span class="o">=</span><span class="n">n_across</span><span class="p">)</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">slide_shape_wh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xywh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">extract_area</span><span class="p">(</span><span class="o">*</span><span class="n">xywh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_slide</span></div>


<div class="viewcode-block" id="BioFormatsSlideReader.slide2image">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.BioFormatsSlideReader.slide2image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        series : int, optional</span>
<span class="sd">            Series number. Defaults to 1</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : ndarray</span>
<span class="sd">            An image of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">. Should be &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>

        <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bf_objects</span><span class="p">()</span>

        <span class="n">rdr</span><span class="o">.</span><span class="n">setSeries</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="n">rdr</span><span class="o">.</span><span class="n">setResolution</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xywh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeX</span><span class="p">()</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeY</span><span class="p">()</span>
            <span class="n">xywh</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rdr</span><span class="o">.</span><span class="n">isRGB</span><span class="p">():</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_rgb</span><span class="p">(</span><span class="n">rdr</span><span class="o">=</span><span class="n">rdr</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_multichannel</span><span class="p">(</span><span class="n">rdr</span><span class="o">=</span><span class="n">rdr</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

        <span class="n">rdr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="BioFormatsSlideReader.create_metadata">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.BioFormatsSlideReader.create_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bf_objects</span><span class="p">()</span>
        <span class="n">meta_xml</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">dumpXML</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n_series</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSeriesCount</span><span class="p">()</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSeries</span><span class="p">()</span>
            <span class="n">slide_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BF_RDR</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rdr</span><span class="o">.</span><span class="n">getFormat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">meta_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_series</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_series</span><span class="p">):</span>
                <span class="n">rdr</span><span class="o">.</span><span class="n">setSeries</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">series_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getImageName</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">temp_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">series_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_name</span><span class="si">}</span><span class="s2">_Series_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

                <span class="n">series_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">slide_format</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

                <span class="n">series_meta</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rgb</span><span class="p">(</span><span class="n">rdr</span><span class="p">)</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_names</span><span class="p">(</span><span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getSizeC</span><span class="p">())</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">n_z</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeZ</span><span class="p">()</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">n_t</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeT</span><span class="p">()</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions</span><span class="p">(</span><span class="n">rdr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">series_meta</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
                    <span class="n">series_meta</span><span class="o">.</span><span class="n">pyvips_interpretation</span> <span class="o">=</span> <span class="s1">&#39;srgb&#39;</span>
                <span class="k">elif</span> <span class="n">series_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">series_meta</span><span class="o">.</span><span class="n">pyvips_interpretation</span> <span class="o">=</span> <span class="s1">&#39;b-w&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">series_meta</span><span class="o">.</span><span class="n">pyvips_interpretation</span> <span class="o">=</span> <span class="s1">&#39;multiband&#39;</span>

                <span class="n">series_meta</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pixel_physical_size</span><span class="p">(</span><span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">bf_pixel_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getPixelType</span><span class="p">())</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">isLittleEndian</span><span class="p">()</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">original_xml</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta_xml</span><span class="p">)</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">FormatTools</span><span class="o">.</span><span class="n">getPixelTypeString</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getPixelType</span><span class="p">()))</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">optimal_tile_wh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getOptimalTileWidth</span><span class="p">())</span>

                <span class="n">meta_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_meta</span>

            <span class="n">i0</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">setSeries</span><span class="p">(</span><span class="n">i0</span><span class="p">)</span>
            <span class="n">rdr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">)</span>
            <span class="n">rdr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">meta_list</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_read_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdr</span><span class="p">,</span> <span class="n">xywh</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="n">np_dtype</span><span class="p">,</span> <span class="n">drange</span> <span class="o">=</span> <span class="n">bf_to_numpy_dtype</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getPixelType</span><span class="p">(),</span>
                                             <span class="n">rdr</span><span class="o">.</span><span class="n">isLittleEndian</span><span class="p">())</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">openBytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">xywh</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">np_dtype</span><span class="p">)</span>
        <span class="n">nrgb</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getRGBChannelCount</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">xywh</span>

        <span class="k">if</span> <span class="n">rdr</span><span class="o">.</span><span class="n">isInterleaved</span><span class="p">():</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">nrgb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nrgb</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">img</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_multichannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdr</span><span class="p">,</span> <span class="n">xywh</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">xywh</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeC</span><span class="p">()</span>
        <span class="n">np_dtype</span><span class="p">,</span> <span class="n">drange</span> <span class="o">=</span> <span class="n">bf_to_numpy_dtype</span><span class="p">(</span><span class="n">rdr</span><span class="o">.</span><span class="n">getPixelType</span><span class="p">(),</span>
                                             <span class="n">rdr</span><span class="o">.</span><span class="n">isLittleEndian</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">n_channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channels</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getIndex</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># ZCT</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">openBytes</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">*</span><span class="n">xywh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">np_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">np_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">img</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_bf_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Bioformat objects</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        rdr : IFormatReader</span>
<span class="sd">            IFormatReader object that is a property of a bioformats.ImageReader.</span>

<span class="sd">        meta : loci.formats.ome.OMEPyramidStore</span>
<span class="sd">            Used to read metadata</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Be sure to close rdr with rdr.close() when it&#39;s no longer needed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Javabridge #</span>
        <span class="c1">#------------#</span>
        <span class="c1"># env = javabridge.jutil.get_env()</span>
        <span class="c1"># rdr = javabridge.JWrapper(javabridge.make_instance(</span>
        <span class="c1">#                           &#39;loci/formats/ImageReader&#39;, &#39;()V&#39;)</span>
        <span class="c1">#                           )</span>

        <span class="c1"># factory = javabridge.JWrapper(javabridge.make_instance(</span>
        <span class="c1">#                              &#39;loci/common/services/ServiceFactory&#39;, &#39;()V&#39;)</span>
        <span class="c1">#                              )</span>

        <span class="c1"># OMEXMLService_class = \</span>
        <span class="c1">#     env.find_class(&#39;loci/formats/services/OMEXMLService&#39;).as_class_object()</span>

        <span class="c1"># Jpype #</span>
        <span class="c1">#-------#</span>

        <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">get_bioformats_reader_and_meta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if image is RGB</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_rgb : bool</span>
<span class="sd">            Whether or not the image is RGB</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">rdr</span><span class="o">.</span><span class="n">isRGB</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimensions of slide at all pyramid levels</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rdr : IFormatReader</span>
<span class="sd">            IFormatReader object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slide_dims : ndarray</span>
<span class="sd">            Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Using javabridge and python-bioformmats, this can be accessed as follows</span>
<span class="sd">        `</span>
<span class="sd">        bf_slide = bioformats.ImageReader(slide_f)</span>
<span class="sd">        bf_img_reader = javabridge.JWrapper(bf_slide.rdr.o)</span>

<span class="sd">        Or</span>
<span class="sd">        with bioformats.ImageReader(slide_f) as bf_slide:</span>
<span class="sd">            bf_img_reader = javabridge.JWrapper(bf_slide.rdr.o)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r0</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getResolution</span><span class="p">()</span>
        <span class="n">n_res</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getResolutionCount</span><span class="p">()</span>
        <span class="n">slide_dims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_res</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_res</span><span class="p">):</span>
            <span class="n">rdr</span><span class="o">.</span><span class="n">setResolution</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">slide_dims</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rdr</span><span class="o">.</span><span class="n">getSizeX</span><span class="p">(),</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeY</span><span class="p">()]</span>

        <span class="n">slide_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slide_dims</span><span class="p">)</span>

        <span class="n">rdr</span><span class="o">.</span><span class="n">setResolution</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slide_dims</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pixel_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get resolutions for each series</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rdr : IFormatReader</span>
<span class="sd">            IFormatReader object.</span>

<span class="sd">        meta : loci.formats.ome.OMEPyramidStore</span>
<span class="sd">            Used to read metadata</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res_xyu : tuple</span>
<span class="sd">            Physical size per pixel and the unit, e.g. u&#39;\u00B5m&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_series</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSeries</span><span class="p">()</span>
        <span class="n">temp_x_res</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">getPixelsPhysicalSizeX</span><span class="p">(</span><span class="n">current_series</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_x_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">temp_x_res</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">BF_MICROMETER</span><span class="p">)</span><span class="o">.</span><span class="n">doubleValue</span><span class="p">())</span>
            <span class="n">y_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getPixelsPhysicalSizeY</span><span class="p">(</span><span class="n">current_series</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">BF_MICROMETER</span><span class="p">)</span><span class="o">.</span><span class="n">doubleValue</span><span class="p">())</span>
            <span class="n">phys_unit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">BF_MICROMETER</span><span class="o">.</span><span class="n">getSymbol</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_res</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">y_res</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">phys_unit</span> <span class="o">=</span> <span class="n">PIXEL_UNIT</span>

        <span class="n">res_xyu</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span><span class="p">,</span> <span class="n">phys_unit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res_xyu</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdr</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get channel names of image</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rdr : IFormatReader</span>
<span class="sd">            IFormatReader object</span>

<span class="sd">        meta : loci.formats.ome.OMEPyramidStore</span>
<span class="sd">            Used to read metadata.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        channel_names : list</span>
<span class="sd">            List of channel names.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nc</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSizeC</span><span class="p">()</span>
        <span class="n">current_series</span> <span class="o">=</span> <span class="n">rdr</span><span class="o">.</span><span class="n">getSeries</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rdr</span><span class="o">.</span><span class="n">isRGB</span><span class="p">():</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">nc</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
                <span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getChannelName</span><span class="p">(</span><span class="n">current_series</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">channel_names</span></div>



<div class="viewcode-block" id="VipsSlideReader">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.VipsSlideReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VipsSlideReader</span><span class="p">(</span><span class="n">SlideReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read slides using pyvips</span>
<span class="sd">    Pyvips includes OpenSlide and so can read those formats as well.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    use_openslide : bool</span>
<span class="sd">        Whether or not openslide can be used to read this slide.</span>

<span class="sd">    is_ome : bool</span>
<span class="sd">        Whether ot not the side is an ome.tiff.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    When using openslide, lower levels can only be read without distortion,</span>
<span class="sd">    if pixman version 0.40.0 is installed. As of Oct 7, 2021, Macports only has</span>
<span class="sd">    pixman version 0.38, which produces distorted lower level images. If using</span>
<span class="sd">    macports may need to install from source do  &quot;./configure --prefix=/opt/local/&quot;</span>
<span class="sd">    when installing from source.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">src_f</span><span class="o">=</span><span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span> <span class="o">=</span> <span class="n">check_to_use_openslide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span> <span class="o">=</span> <span class="n">check_is_ome</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metadata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_xml</span><span class="p">()</span>

<div class="viewcode-block" id="VipsSlideReader.create_metadata">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.VipsSlideReader.create_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;image-description&quot;</span> <span class="ow">in</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
            <span class="n">is_image_J</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;imagej&quot;</span><span class="p">,</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image-description&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">is_image_J</span><span class="p">:</span>
                <span class="n">slide_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_bf</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">slide_meta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span><span class="p">:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">OPENSLIDE_RDR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">VIPS_RDR</span>

        <span class="n">meta_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_Series(0)&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">meta_name</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>

        <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rgb</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span> <span class="ow">and</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">hasalpha</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span><span class="p">:</span>
            <span class="c1"># Will also remove alpha channel after reading</span>
            <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span> <span class="o">-</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">hasalpha</span><span class="p">()</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">vips_img</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">slide_meta</span><span class="o">.</span><span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="n">img_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_xml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">metadata_from_xml</span><span class="p">(</span><span class="n">xml</span><span class="o">=</span><span class="n">img_xml</span><span class="p">,</span>
                                              <span class="n">name</span><span class="o">=</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
                                              <span class="n">metadata</span><span class="o">=</span><span class="n">slide_meta</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">slide_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_vips</span><span class="p">(</span><span class="n">slide_meta</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">slide_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_vips</span><span class="p">(</span><span class="n">slide_meta</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
            <span class="n">slide_meta</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
            <span class="n">toilet_roll</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
            <span class="n">n_pages</span> <span class="o">=</span> <span class="n">toilet_roll</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="n">page</span><span class="o">.</span><span class="n">height</span>
            <span class="k">if</span> <span class="n">n_pages</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_pages</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slide_meta</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">verify_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">img_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">original_xml</span>
        <span class="k">if</span> <span class="n">img_xml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span><span class="p">:</span>
            <span class="c1"># Don&#39;t check openslide images, as metadata counts alpha channel</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ome_info</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">img_xml</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_info</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">read_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">check_xml_img_match</span><span class="p">(</span><span class="n">xml</span><span class="o">=</span><span class="n">img_xml</span><span class="p">,</span> <span class="n">vips_img</span><span class="o">=</span><span class="n">read_img</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_metadata_vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide_meta</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_names</span><span class="p">(</span><span class="n">vips_img</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">=</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pixel_physical_size</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="n">np_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">VIPS_FORMAT_NUMPY_DTYPE</span><span class="p">[</span><span class="n">vips_img</span><span class="o">.</span><span class="n">format</span><span class="p">]</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_BF_DTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">np_dtype</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">bf_pixel_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">BF_DTYPE_PIXEL_TYPE</span><span class="p">[</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">bf_datatype</span><span class="p">]</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">original_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">optimal_tile_wh</span> <span class="o">=</span> <span class="n">get_tile_wh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">slide_meta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_metadata_bf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
            <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_slide2vips_ome_one_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use pyvips to read an ome.tiff image that has only 1 series</span>

<span class="sd">        Pyvips throws an error when trying to read other series</span>
<span class="sd">        because they may have a different shape than the 1st one</span>
<span class="sd">        https://github.com/libvips/pyvips/issues/262</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vips_slide : pyvips.Image</span>
<span class="sd">            An  of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">toilet_roll</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">interpretation</span> <span class="ow">in</span> <span class="n">VIPS_RGB_FORMATS</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page_height</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">toilet_roll</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">toilet_roll</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">page_height</span><span class="p">)</span> <span class="k">for</span>
                     <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">toilet_roll</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">page_height</span><span class="p">)]</span>

            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bandjoin</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">bands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;b-w&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;multiband&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_slide</span>

<div class="viewcode-block" id="VipsSlideReader.slide2vips">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.VipsSlideReader.slide2vips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to pyvips.Image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vips_slide : pyvips.Image</span>
<span class="sd">            An  of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span><span class="p">:</span>
            <span class="c1"># Keep rgb=False returns rgba. Makes it possible to avoid having black pixels for background. Can remove alpha channel after</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">autocrop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide2vips_ome_one_series</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Pyramid image but each level is a page, not a SubIFD</span>
                    <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Regular images like png or jpeg don&#39;t have SubIFD or pages</span>
                    <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_rgb</span> <span class="ow">and</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">hasalpha</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Remove alpha channel</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">xywh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">extract_area</span><span class="p">(</span><span class="o">*</span><span class="n">xywh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_slide</span></div>


<div class="viewcode-block" id="VipsSlideReader.slide2image">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.VipsSlideReader.slide2image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level.</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : ndarray</span>
<span class="sd">            An image of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">. Should be &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">vips_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">vips2numpy</span><span class="p">(</span><span class="n">vips_slide</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_img</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if image is RGB</span>

<span class="sd">        See https://github.com/libvips/libvips/issues/580#issuecomment-272804812</span>
<span class="sd">        3 types of RGB</span>
<span class="sd">        srgb = 0-255, uint8</span>
<span class="sd">        rgb16 =  0-65535, uint16</span>
<span class="sd">        scrgb = 0-1, float</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_rgb : bool</span>
<span class="sd">            Whether or not the image is RGB.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">is_rgb</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">interpretation</span> <span class="ow">in</span> <span class="n">VIPS_RGB_FORMATS</span>

        <span class="k">return</span> <span class="n">is_rgb</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
        <span class="n">img_desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;openslide.vendor&quot;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">img_desc</span> <span class="o">=</span> <span class="n">openslide_desc_2_omexml</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;image-description&quot;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">img_desc</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image-description&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">img_desc</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get names of each channel</span>

<span class="sd">        Get list of channel names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        channel_names : list</span>
<span class="sd">            List of channel naames.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;n-pages&#39;</span> <span class="ow">in</span> <span class="n">vips_fields</span> <span class="ow">and</span> <span class="s2">&quot;image-description&quot;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">n_pages</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n-pages&quot;</span><span class="p">)</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pages</span><span class="p">):</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">page_fields</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;image-description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">page_fields</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">page_metadata</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image-description&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
                    <span class="n">page_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page_metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;lxml&quot;</span><span class="p">)</span>

                <span class="n">cname</span> <span class="o">=</span> <span class="n">page_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cname</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channel_names</span><span class="p">:</span>
                        <span class="n">channel_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cname</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">is_vips_rgb</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">interpretation</span> <span class="ow">in</span> <span class="n">VIPS_RGB_FORMATS</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">channel_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_vips_rgb</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">get_default_channel_names</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span><span class="p">,</span>
                                                      <span class="n">src_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimensions of slide at all pyramid levels using openslide.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slide_dims : ndarray</span>
<span class="sd">            Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span><span class="p">:</span>
            <span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions_openslide</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
            <span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions_ometiff</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions_vips</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slide_dimensions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions_ometiff_bf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
            <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions_ometiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>

        <span class="k">if</span> <span class="s2">&quot;n-subifds&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
            <span class="c1"># non-pyramid ome.tiff</span>
            <span class="n">slide_dims_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions_vips</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">unique_dim_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">slide_dims_wh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">slide_dims_wh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">slide_dims_wh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_dim_idx</span><span class="p">)])</span>

            <span class="k">return</span> <span class="n">slide_dims_wh</span>

        <span class="n">n_levels</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n-subifds&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">slide_dims_wh</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_levels</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">slide_dims_wh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">page</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>

        <span class="n">slide_dims_wh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slide_dims_wh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slide_dims_wh</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions_openslide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimensions of slide at all pyramid levels using openslide and autocrop option</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slide_dims : ndarray</span>
<span class="sd">            Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openslide.level-count&#39;</span><span class="p">))</span>
        <span class="n">slide_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">warp_tools</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">autocrop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">slide_dims</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions_vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimensions of slide at all pyramid levels using vips</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slide_dims : ndarray</span>
<span class="sd">            Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;n-pages&#39;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">n_pages</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n-pages&quot;</span><span class="p">)</span>
            <span class="n">all_dims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_channels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pages</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error at page </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">w</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">width</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">bands</span>

                <span class="n">all_dims</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
                <span class="n">all_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">most_common_channel_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">all_channels</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">most_common_channel_count</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">all_channels</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">all_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_dims</span><span class="p">)</span>
            <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_channels</span> <span class="o">==</span> <span class="n">most_common_channel_count</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">slide_dims</span> <span class="o">=</span> <span class="n">all_dims</span><span class="p">[</span><span class="n">keep_idx</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">slide_dims</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vips_img</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">height</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slide_dims</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pixel_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get resolution of slide</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res_xyu : tuple</span>
<span class="sd">            Physical size per pixel and the unit, e.g. u&#39;\u00B5m&#39;</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            If physical unit is micron, it must be u&#39;\u00B5m&#39;,</span>
<span class="sd">            not mu (u&#39;\u03bcm&#39;) or u.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res_xyu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openslide</span><span class="p">:</span>
            <span class="n">x_res</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openslide.mpp-x&#39;</span><span class="p">))</span>
            <span class="n">y_res</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openslide.mpp-y&#39;</span><span class="p">))</span>
            <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slide-associated-images&#39;</span><span class="p">)</span>
            <span class="n">phys_unit</span> <span class="o">=</span> <span class="n">MICRON_UNIT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_res</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xres&quot;</span><span class="p">)</span>
            <span class="n">y_res</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yres&quot;</span><span class="p">)</span>
            <span class="n">has_units</span> <span class="o">=</span> <span class="s2">&quot;resolution-unit&quot;</span> <span class="ow">in</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x_res</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_res</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">has_units</span><span class="p">:</span>
                <span class="c1"># in vips, x_res and y_res are px/mm (https://www.libvips.org/API/current/VipsImage.html#VipsImage--xres)</span>
                <span class="c1"># Need to convert to um/px</span>
                <span class="n">x_res</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">x_res</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">y_res</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">y_res</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">phys_unit</span> <span class="o">=</span> <span class="n">MICRON_UNIT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default value is 0, so not provided</span>
                <span class="n">x_res</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">y_res</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">phys_unit</span> <span class="o">=</span> <span class="n">PIXEL_UNIT</span>

        <span class="n">res_xyu</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span><span class="p">,</span> <span class="n">phys_unit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res_xyu</span></div>



<div class="viewcode-block" id="FlattenedPyramidReader">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.FlattenedPyramidReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FlattenedPyramidReader</span><span class="p">(</span><span class="n">VipsSlideReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read flattened pyramid using pyvips</span>
<span class="sd">    Read slide pyramids where each page/plane is a channel in the pyramid.</span>
<span class="sd">    An example would be one where the plane dimensions are</span>
<span class="sd">    something like</span>
<span class="sd">    [(600, 600), (600, 600), (600, 600), (300, 300), (300, 300), (300, 300)]</span>
<span class="sd">    for a 3 channel image with  2  pyramid levels. It seems that bioformats</span>
<span class="sd">    does not recognize these as pyramid images.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># BF Datatype may not match min/max values in the image</span>
        <span class="c1"># e.g. datatype is uint32, but min and max are floats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">()</span>


<div class="viewcode-block" id="FlattenedPyramidReader.create_metadata">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.FlattenedPyramidReader.create_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">is_flattended_pyramid</span><span class="p">,</span> <span class="n">bf_reads_flat</span><span class="p">,</span> <span class="n">slide_dimensions</span><span class="p">,</span>\
        <span class="n">levels_start_idx</span><span class="p">,</span> <span class="n">n_channels</span> <span class="o">=</span> \
            <span class="n">check_flattened_pyramid_tiff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">is_flattended_pyramid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bf_reads_flat</span><span class="p">,</span> <span class="s2">&quot;Trying to use FlattenedPyramidReader but slide is not a flattened pyramid&quot;</span>

        <span class="n">meta_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_Series(0)&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">VIPS_RDR</span>
        <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">meta_name</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">slide_dimensions</span> <span class="o">=</span> <span class="n">slide_dimensions</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">n_channels</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">levels_start_idx</span> <span class="o">=</span> <span class="n">levels_start_idx</span>

        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rgb</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_page_count</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>

        <span class="n">img_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>
        <span class="n">can_read_xml</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">img_xml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">metadata_from_xml</span><span class="p">(</span><span class="n">xml</span><span class="o">=</span><span class="n">img_xml</span><span class="p">,</span>
                                              <span class="n">name</span><span class="o">=</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
                                              <span class="n">metadata</span><span class="o">=</span><span class="n">slide_meta</span><span class="p">)</span>
               <span class="n">can_read_xml</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">slide_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_vips</span><span class="p">(</span><span class="n">slide_meta</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">slide_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_vips</span><span class="p">(</span><span class="n">slide_meta</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
            <span class="n">slide_meta</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">can_read_xml</span><span class="p">:</span>
            <span class="c1"># Verify basic info of read image matches xml</span>
            <span class="n">read_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">check_xml_img_match</span><span class="p">(</span><span class="n">img_xml</span><span class="p">,</span> <span class="n">read_img</span><span class="p">,</span> <span class="n">slide_meta</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slide_meta</span></div>


<div class="viewcode-block" id="FlattenedPyramidReader.slide2vips">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.FlattenedPyramidReader.slide2vips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to pyvips.Image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vips_slide : pyvips.Image</span>
<span class="sd">            An  of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">. Should be &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">level_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">levels_start_idx</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
        <span class="n">vips_slide</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">level_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">level_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">n_pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
            <span class="n">page_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">page</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">page_shape</span> <span class="o">==</span> <span class="n">level_shape</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">vips_slide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">page</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">bandjoin</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xywh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">extract_area</span><span class="p">(</span><span class="o">*</span><span class="n">xywh</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Min/max/response datatypes in xml don&#39;t match values image.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bio-formats datatype is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span><span class="si">}</span><span class="s2">, &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;but min/max/response values in xml are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span><span class="si">}</span><span class="s2">. &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;Converting to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                   <span class="p">)</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">vips_dtype</span> <span class="o">=</span> <span class="n">bf2vips_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span><span class="p">)</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">vips_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">img_dtype</span>

        <span class="k">if</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">bands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;b-w&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">bands</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;uchar&#39;</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;srgb&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vips_slide</span> <span class="o">=</span> <span class="n">vips_slide</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;multiband&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_slide</span></div>


<div class="viewcode-block" id="FlattenedPyramidReader.slide2image">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.FlattenedPyramidReader.slide2image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">. Should be &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">vips_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">vips2numpy</span><span class="p">(</span><span class="n">vips_slide</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Big hack for when get the error &quot;tiff2vips: out of order read&quot; even with random access</span>
            <span class="n">out_shape_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="n">msg1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pyvips.error.Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> when converting pvips.Image to numpy array&quot;</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Will try to resize level 0 to have shape </span><span class="si">{</span><span class="n">out_shape_wh</span><span class="si">}</span><span class="s2"> and convert&quot;</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg2</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_shape_wh</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">l0_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">resized</span> <span class="o">=</span> <span class="n">l0_slide</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">vips2numpy</span><span class="p">(</span><span class="n">resized</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">out_shape_wh</span><span class="p">):</span>
                <span class="n">vips_img</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">vips_img</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="n">out_shape_wh</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_img</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get names of each channel</span>

<span class="sd">        Get list of channel names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vips_img : pyvips.Image</span>
<span class="sd">            pyvips.Image of slide.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        channel_names : list</span>
<span class="sd">            List of channel naames.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cname_from_tag_name</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
            <span class="s2">&quot;Ex .qptiff&quot;</span>

            <span class="n">cnames</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^Name$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cnames</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">cnames</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cname_from_tag_channel</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
            <span class="s2">&quot;Ex. Indica labs HALO&quot;</span>

            <span class="n">cnames</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^Channel$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">))</span>

            <span class="n">name_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">name_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">name_tags</span> <span class="k">if</span> <span class="n">cnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name_tag</span> <span class="o">=</span> <span class="n">name_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cnames</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">return</span> <span class="n">names</span>

        <span class="n">default_channel_names</span> <span class="o">=</span> <span class="n">get_default_channel_names</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">bands</span><span class="p">,</span>
                                                          <span class="n">src_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;image-description&quot;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">img_desc</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image-description&quot;</span><span class="p">)</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">img_desc</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span><span class="p">)</span>

            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">cname_from_tag_name</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">channel_names</span> <span class="o">=</span> <span class="n">cname_from_tag_channel</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">channel_names</span> <span class="o">=</span> <span class="n">default_channel_names</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">default_channel_names</span>

        <span class="k">return</span> <span class="n">channel_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_page_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vips_img</span><span class="p">):</span>
        <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;n-pages&#39;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">n_pages</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n-pages&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_pages</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">n_pages</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Bio-Formats datatype from values in metadata.</span>

<span class="sd">        For example, BF metadata may have image datatype as</span>
<span class="sd">        uint32, but in the image descriiption, min/max/resppnse,</span>
<span class="sd">        are floats. This will determine if the slide should be cast</span>
<span class="sd">        to a different dataatype to match values in metadata.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smallest_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">vips_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">smallest_level</span><span class="p">)</span>
        <span class="n">vips_fields</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
        <span class="n">current_bf_dtype</span> <span class="o">=</span> <span class="n">vips2bf_dtype</span><span class="p">(</span><span class="n">vips_img</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="n">bf_type</span> <span class="o">=</span> <span class="n">current_bf_dtype</span>
        <span class="k">if</span> <span class="s1">&#39;n-pages&#39;</span> <span class="ow">in</span> <span class="n">vips_fields</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">page_metadata</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image-description&quot;</span><span class="p">)</span>

            <span class="n">page_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page_metadata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;lxml&quot;</span><span class="p">)</span>
            <span class="c1"># channels = page_soup.findAll(&quot;channel&quot;) # deprecated</span>
            <span class="c1"># response = page_soup.findAll(&quot;response&quot;) # deprecated</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">page_soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">page_soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Indica Labs tiff</span>
                <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chnl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">chnl</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">):</span>
                        <span class="n">max_v</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">chnl</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>
                        <span class="n">dtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_v</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># PerkinElmer-QPI tiff</span>
                <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">))</span>
                    <span class="n">dtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="p">])</span><span class="o">.</span><span class="n">dtype</span>
                    <span class="n">dtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">current_bf_dtype</span>

            <span class="n">unique_dtypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_dtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;More than 1 datatype. Will not try to scale values&quot;</span>
                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">img_dtype</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img_dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">vals_are_floats</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">img_dtype</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">img_is_int</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">current_bf_dtype</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">vals_are_floats</span> <span class="ow">and</span> <span class="n">img_is_int</span><span class="p">:</span>
                <span class="n">max_v</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="n">bf_px_num_type</span> <span class="o">=</span> <span class="n">FormatTools</span><span class="o">.</span><span class="n">pixelTypeFromString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span><span class="p">)</span>
                <span class="n">temp_np_type</span><span class="p">,</span> <span class="n">max_v_for_type</span> <span class="o">=</span> <span class="n">bf_to_numpy_dtype</span><span class="p">(</span><span class="n">bf_px_num_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">temp_np_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">):</span>
                    <span class="n">np_type</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span>
                <span class="k">elif</span> <span class="n">temp_np_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;8&#39;</span><span class="p">):</span>
                    <span class="n">np_type</span> <span class="o">=</span> <span class="s2">&quot;float64&quot;</span>

                <span class="n">bf_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_BF_DTYPE</span><span class="p">[</span><span class="n">np_type</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bf_type</span> <span class="o">=</span> <span class="n">current_bf_dtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bf_type</span> <span class="o">=</span> <span class="n">current_bf_dtype</span>

        <span class="k">return</span> <span class="n">bf_type</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">CziJpgxrReader</span><span class="p">(</span><span class="n">SlideReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read slides and get metadata</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    slide_f : str</span>
<span class="sd">        Path to slide</span>

<span class="sd">    metadata : MetaData</span>
<span class="sd">        MetaData containing some basic metadata about the slide</span>

<span class="sd">    series : int</span>
<span class="sd">        Image series</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        src_f : str</span>
<span class="sd">            Path to slide</span>

<span class="sd">        series : int</span>
<span class="sd">            The series to be read. If `series` is None, the the `series`</span>
<span class="sd">            will be set to the series associated with the largest image.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">aicspylibczi</span><span class="w"> </span><span class="kn">import</span> <span class="n">CziFile</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please install aicspylibczi&quot;</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">)</span>

        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_meta_dict</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">etree_to_dict</span><span class="p">(</span><span class="n">czi_reader</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_bgr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">src_f</span><span class="o">=</span><span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metadata</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_series</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img_areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span><span class="p">]</span>
            <span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">img_areas</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_areas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No series provided. &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;Selecting series with largest image, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;which is series </span><span class="si">{</span><span class="n">series</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">warning_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">valtils</span><span class="o">.</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">series</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_series</span> <span class="o">=</span> <span class="n">series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_list</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_series</span>

    <span class="n">series</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="o">=</span><span class="n">_get_series</span><span class="p">,</span>
                      <span class="n">fset</span><span class="o">=</span><span class="n">_set_series</span><span class="p">,</span>
                      <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Slide scene&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_whole_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        img : ndarray</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">shp</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">shp</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bgr</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_img</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Note, tried multiprocessing (see below), but get blank image.</span>
        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="n">out_shape_wh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tile_bboxes</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">get_all_mosaic_tile_bounding_boxes</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">black</span><span class="p">(</span><span class="o">*</span><span class="n">out_shape_wh</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">n_channels</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building CZI mosaic for </span><span class="si">{</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tile_info</span><span class="p">,</span> <span class="n">tile_bbox</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">tile_bboxes</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">tile_info</span><span class="o">.</span><span class="n">m_index</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">tile_bbox</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">tile_bbox</span><span class="o">.</span><span class="n">y</span>

            <span class="n">np_tile</span><span class="p">,</span> <span class="n">tile_dims</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">read_image</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>

            <span class="n">slice_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tile_dims</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">]]</span>

            <span class="n">np_tile</span> <span class="o">=</span> <span class="n">np_tile</span><span class="p">[(</span><span class="o">*</span><span class="n">slice_dims</span><span class="p">,</span> <span class="o">...</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bgr</span><span class="p">:</span>
                <span class="n">np_tile</span> <span class="o">=</span> <span class="n">np_tile</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">vips_tile</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">np_tile</span><span class="p">)</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">vips_tile</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_img</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">slide2vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">. Should be &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Image is mosaic</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mosaic</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading whole image&quot;</span><span class="p">)</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_whole_img</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xywh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">extract_area</span><span class="p">(</span><span class="o">*</span><span class="n">xywh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">_zoom_levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">rescale_img</span><span class="p">(</span><span class="n">vips_img</span><span class="p">,</span> <span class="n">scaling</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bgr</span><span class="p">:</span>
            <span class="n">vips_img</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;srgb&quot;</span><span class="p">)</span>

        <span class="n">np_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">CZI_FORMAT_TO_BF_FORMAT</span><span class="p">[</span><span class="n">czi_reader</span><span class="o">.</span><span class="n">pixel_type</span><span class="p">]</span>
        <span class="n">vips_type</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_VIPS_DTYPE</span><span class="p">[</span><span class="n">np_type</span><span class="p">]</span>
        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">vips_img</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">vips_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_img</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">slide2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert slide to image</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        level : int</span>
<span class="sd">            Pyramid level</span>

<span class="sd">        xywh : tuple of int, optional</span>
<span class="sd">            The region to be sliced from the slide. If None,</span>
<span class="sd">            then the entire slide will be converted. Otherwise</span>
<span class="sd">            xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">            the region to be sliced.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        img : ndarray</span>
<span class="sd">            An image of the slide or the region defined by xywh</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level is negative </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="si">}</span><span class="s2">. Should be &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">vips_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">np_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">vips2numpy</span><span class="p">(</span><span class="n">vips_img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np_img</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create and fill in a MetaData object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        metadata : MetaData</span>
<span class="sd">            MetaData object containing metadata about slide</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">dims_dict</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">get_dims_shape</span><span class="p">()</span>

        <span class="n">n_scenes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_dict</span><span class="p">)</span>
        <span class="n">meta_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_scenes</span>
        <span class="n">phys_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pixel_physical_size</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
            <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
            <span class="n">original_xml</span> <span class="o">=</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">original_xml</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_scenes</span><span class="p">):</span>

            <span class="n">temp_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_name</span><span class="si">}</span><span class="s2">_Scene_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">series_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="s2">&quot;aicspylibczi&quot;</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

            <span class="n">series_meta</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rgb</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">series_meta</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
                <span class="n">n_channels</span> <span class="o">=</span> <span class="n">dims_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;A&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">series_meta</span><span class="o">.</span><span class="n">pyvips_interpretation</span> <span class="o">=</span> <span class="s1">&#39;srgb&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_channels</span> <span class="o">=</span> <span class="n">dims_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;C&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">series_meta</span><span class="o">.</span><span class="n">pyvips_interpretation</span> <span class="o">=</span> <span class="s1">&#39;b-w&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">series_meta</span><span class="o">.</span><span class="n">pyvips_interpretation</span> <span class="o">=</span> <span class="s1">&#39;multiband&#39;</span>

            <span class="n">series_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">n_channels</span>
            <span class="n">series_meta</span><span class="o">.</span><span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">series_meta</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">CZI_FORMAT_TO_BF_FORMAT</span><span class="p">[</span><span class="n">czi_reader</span><span class="o">.</span><span class="n">pixel_type</span><span class="p">]</span>
            <span class="n">series_meta</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_names</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">series_meta</span><span class="p">)</span>

            <span class="n">series_meta</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="n">phys_size</span>
            <span class="n">series_meta</span><span class="o">.</span><span class="n">original_xml</span> <span class="o">=</span> <span class="n">original_xml</span>
            <span class="n">series_meta</span><span class="o">.</span><span class="n">_zoom_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zoom_levels</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">meta_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_meta</span>


        <span class="k">return</span> <span class="n">meta_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_img_meta_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_meta_dict</span><span class="p">[</span><span class="s2">&quot;ImageDocument&quot;</span><span class="p">][</span><span class="s2">&quot;Metadata&quot;</span><span class="p">][</span><span class="s2">&quot;Information&quot;</span><span class="p">][</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if image is RGB</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_rgb : bool</span>
<span class="sd">            Whether or not the image is RGB</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_bgr</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">pixel_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bgr&quot;</span><span class="p">)</span>
        <span class="n">_is_rgb</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">pixel_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rgb&quot;</span><span class="p">)</span>
        <span class="n">is_rgb</span>  <span class="o">=</span><span class="n">_is_rgb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bgr</span>

        <span class="k">return</span> <span class="n">is_rgb</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names_aics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get names of each channel</span>

<span class="sd">        Get list of channel names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        channel_names : list</span>
<span class="sd">            List of channel names</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">img_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_img_meta_dict</span><span class="p">()</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">img_dict</span><span class="p">[</span><span class="s2">&quot;Dimensions&quot;</span><span class="p">][</span><span class="s2">&quot;Channels&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;Channel&quot;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="s2">&quot;Channel&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;@Name&quot;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="s2">&quot;@Name&quot;</span><span class="p">]]</span>

            <span class="k">return</span> <span class="n">channel_names</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_channel_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;@Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">]</span>
            <span class="n">all_channel_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;@Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">]</span>
            <span class="n">max_c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">eval</span><span class="p">(</span><span class="n">img_dict</span><span class="p">[</span><span class="s2">&quot;SizeC&quot;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_channel_ids</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_c</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">eval</span><span class="p">(</span><span class="n">img_dict</span><span class="p">[</span><span class="s2">&quot;SizeC&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">chnl_attr</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">chnl_name</span> <span class="o">=</span> <span class="n">chnl_attr</span><span class="p">[</span><span class="s2">&quot;@Name&quot;</span><span class="p">]</span>
            <span class="n">chnl_idx</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">chnl_attr</span><span class="p">[</span><span class="s2">&quot;@Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">channel_names</span><span class="p">[</span><span class="n">chnl_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chnl_name</span>

        <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channel_names</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">channel_names</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names_bf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get names of each channel</span>

<span class="sd">        Get list of channel names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        channel_names : list</span>
<span class="sd">            List of channel names</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">is_rgb</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


        <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
            <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="n">rdr</span><span class="p">,</span> <span class="n">bf_meta</span> <span class="o">=</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">_get_bf_objects</span><span class="p">()</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">_get_channel_names</span><span class="p">(</span><span class="n">rdr</span><span class="p">,</span> <span class="n">bf_meta</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">channel_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_names_aics</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimensions of slide at all pyramid levels</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        slide_dims : ndarray</span>
<span class="sd">            Dimensions of all images in the pyramid (width, height).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zoom_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zoom_levels</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>

        <span class="n">czi_reader</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">scene_bbox</span> <span class="o">=</span> <span class="n">czi_reader</span><span class="o">.</span><span class="n">get_all_scene_bounding_boxes</span><span class="p">()[</span><span class="n">scene</span><span class="p">]</span>
        <span class="n">scence_l0_wh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scene_bbox</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">scene_bbox</span><span class="o">.</span><span class="n">h</span><span class="p">])</span>
        <span class="n">slide_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scence_l0_wh</span><span class="o">*</span><span class="n">zoom_levels</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slide_dimensions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_zoom_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="n">img_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_img_meta_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;S&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">img_dict</span><span class="p">[</span><span class="s2">&quot;Dimensions&quot;</span><span class="p">]:</span>
            <span class="c1"># No pyramid levels</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="n">scene_dict</span> <span class="o">=</span> <span class="n">img_dict</span><span class="p">[</span><span class="s2">&quot;Dimensions&quot;</span><span class="p">][</span><span class="s2">&quot;S&quot;</span><span class="p">][</span><span class="s2">&quot;Scenes&quot;</span><span class="p">][</span><span class="s2">&quot;Scene&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scene</span> <span class="ow">in</span> <span class="n">scene_dict</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scene_dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">pyramid_info</span> <span class="o">=</span> <span class="n">scene_dict</span><span class="p">[</span><span class="n">scene</span><span class="p">][</span><span class="s2">&quot;PyramidInfo&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pyramid_info</span> <span class="o">=</span> <span class="n">scene_dict</span><span class="p">[</span><span class="s2">&quot;PyramidInfo&quot;</span><span class="p">]</span>

        <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">pyramid_info</span><span class="p">[</span><span class="s2">&quot;PyramidLayersCount&quot;</span><span class="p">])</span>
        <span class="n">downsampling</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">pyramid_info</span><span class="p">[</span><span class="s2">&quot;MinificationFactor&quot;</span><span class="p">])</span>
        <span class="n">zoom_levels</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">downsampling</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">zoom_levels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pixel_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get resolution of slide</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res_xyu : tuple</span>
<span class="sd">            Physical size per pixel and the unit, e.g. u&#39;\u00B5m&#39;</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            If physical unit is micron, it must be u&#39;\u00B5m&#39;,</span>
<span class="sd">            not mu (u&#39;\u03bcm&#39;) or u.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">physical_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_meta_dict</span><span class="p">[</span><span class="s2">&quot;ImageDocument&quot;</span><span class="p">][</span><span class="s2">&quot;Metadata&quot;</span><span class="p">][</span><span class="s2">&quot;Scaling&quot;</span><span class="p">][</span><span class="s2">&quot;Items&quot;</span><span class="p">][</span><span class="s2">&quot;Distance&quot;</span><span class="p">]</span>

        <span class="n">physical_size_xyu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">physical_unit</span> <span class="o">=</span> <span class="n">physical_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;DefaultUnitFormat&quot;</span><span class="p">]</span>
        <span class="n">physical_size_xyu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">physical_unit</span>

        <span class="k">if</span> <span class="n">physical_unit</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u00B5</span><span class="s1">m&#39;</span><span class="p">:</span>
            <span class="n">physical_scaling</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="k">elif</span> <span class="n">physical_unit</span> <span class="o">==</span> <span class="s2">&quot;mm&quot;</span><span class="p">:</span>
            <span class="n">physical_scaling</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
        <span class="k">elif</span> <span class="n">physical_unit</span> <span class="o">==</span> <span class="s2">&quot;cm&quot;</span><span class="p">:</span>
            <span class="n">physical_scaling</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">physical_scaling</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">physical_sizes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s2">&quot;@Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="n">physical_size_xyu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">physical_scaling</span>
            <span class="k">elif</span> <span class="n">ps</span><span class="p">[</span><span class="s2">&quot;@Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
                <span class="n">physical_size_xyu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">physical_scaling</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">physical_size_xyu</span><span class="p">)</span>


<div class="viewcode-block" id="ImageReader">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.ImageReader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageReader</span><span class="p">(</span><span class="n">SlideReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read image using scikit-image</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metadata</span><span class="p">()</span>

<div class="viewcode-block" id="ImageReader.create_metadata">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.ImageReader.create_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">IMG_RDR</span>
        <span class="n">meta_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_Series(0)&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">meta_name</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
        <span class="n">pil_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rgb</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_names</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_channels</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PIXEL_UNIT</span><span class="p">]</span>
        <span class="n">slide_meta</span><span class="o">.</span><span class="n">slide_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slide_dimensions</span><span class="p">(</span><span class="n">pil_img</span><span class="p">)</span>

        <span class="n">f_extension</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f_extension</span> <span class="ow">in</span> <span class="n">BF_READABLE_FORMATS</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">valtils</span><span class="o">.</span><span class="n">HiddenPrints</span><span class="p">():</span>
                <span class="n">bf_reader</span> <span class="o">=</span> <span class="n">BioFormatsSlideReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

            <span class="n">slide_meta</span><span class="o">.</span><span class="n">original_xml</span> <span class="o">=</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">original_xml</span>
            <span class="n">slide_meta</span><span class="o">.</span><span class="n">bf_datatype</span> <span class="o">=</span> <span class="n">bf_reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bf_datatype</span>
        <span class="n">pil_img</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">slide_meta</span></div>


<div class="viewcode-block" id="ImageReader.slide2vips">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.ImageReader.slide2vips">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2vips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide2image</span><span class="p">(</span><span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">vips_img</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vips_img</span></div>


<div class="viewcode-block" id="ImageReader.slide2image">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.ImageReader.slide2image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">slide2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xywh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xywh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xywh</span><span class="p">)</span>
            <span class="n">start_c</span><span class="p">,</span> <span class="n">start_r</span> <span class="o">=</span> <span class="n">xywh</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">end_c</span><span class="p">,</span> <span class="n">end_r</span> <span class="o">=</span> <span class="n">xywh</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">xywh</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">start_r</span><span class="p">:</span><span class="n">end_r</span><span class="p">,</span> <span class="n">start_c</span><span class="p">:</span><span class="n">end_c</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">img</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_slide_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pil_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pil_img</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">pil_img</span><span class="o">.</span><span class="n">height</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">img_dims</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_n_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pil_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pil_img</span><span class="o">.</span><span class="n">getbands</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">n_channels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pil_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">is_rgb</span> <span class="o">=</span> <span class="n">pil_img</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;RGB&#39;</span>

        <span class="k">return</span> <span class="n">is_rgb</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pil_img</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">is_rgb</span> <span class="o">=</span> <span class="n">pil_img</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;RGB&#39;</span>
        <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel_names</span> <span class="o">=</span> <span class="n">pil_img</span><span class="o">.</span><span class="n">getbands</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">channel_names</span></div>



<div class="viewcode-block" id="get_slide_reader">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.get_slide_reader">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_slide_reader</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get appropriate SlideReader</span>

<span class="sd">    If a slide can be read by openslide and bioformats, VipsSlideReader will be used</span>
<span class="sd">    because it can be opened as a pyvips.Image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_f : str</span>
<span class="sd">        Path to slide</span>

<span class="sd">    series : int, optional</span>
<span class="sd">        The series to be read. If `series` is None, the the `series`</span>
<span class="sd">        will be set to the series associated with the largest image.</span>
<span class="sd">        In cases where there is only 1 image in the file, `series`</span>
<span class="sd">        will be 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    reader: SlideReader</span>
<span class="sd">        SlideReader class that can read the slide and and convert them to</span>
<span class="sd">        images or pyvips.Images at the specified level and series. They</span>
<span class="sd">        also contain a `MetaData` object that contains information about</span>
<span class="sd">        the slide, like dimensions at each level, physical units, etc...</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    pyvips will be used to open ome-tiff images when `series` is 0</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">src_f</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">f_extension</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f_extension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unable to find reader to open </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">src_f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">is_ome_tiff</span> <span class="o">=</span> <span class="n">check_is_ome</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">is_tiff</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.tif*&quot;</span><span class="p">,</span> <span class="n">f_extension</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ome_tiff</span>
    <span class="n">is_czi</span> <span class="o">=</span> <span class="n">f_extension</span> <span class="o">==</span> <span class="s2">&quot;.czi&quot;</span>

    <span class="n">is_flattened_tiff</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">bf_reads_flat</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">is_tiff</span><span class="p">:</span>
        <span class="n">is_flattened_tiff</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">check_flattened_pyramid_tiff</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">check_with_bf</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">one_series</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">is_ome_tiff</span><span class="p">:</span>
        <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">one_series</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_obj</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>

    <span class="n">can_use_vips</span> <span class="o">=</span> <span class="n">check_to_use_vips</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="n">can_use_openslide</span> <span class="o">=</span> <span class="n">check_to_use_openslide</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span> <span class="c1"># Checks openslide is installed</span>

    <span class="c1"># Give preference to vips/openslide since it will be fastest</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">can_use_vips</span> <span class="ow">or</span> <span class="n">can_use_openslide</span><span class="p">)</span> <span class="ow">and</span> <span class="n">one_series</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_flattened_tiff</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">VipsSlideReader</span>

    <span class="k">if</span> <span class="n">is_czi</span><span class="p">:</span>
        <span class="n">is_jpegxr</span> <span class="o">=</span> <span class="n">check_czi_jpegxr</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="n">is_m1_mac</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">check_m1_mac</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_m1_mac</span> <span class="ow">and</span> <span class="n">is_jpegxr</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Will likely be errors using Bioformats to read a JPEGXR compressed CZI on this Apple M1 machine. Will use CziJpgxrReader instead.&quot;</span>
            <span class="k">return</span> <span class="n">CziJpgxrReader</span>

    <span class="c1"># Check to see if Bio-formats will work</span>
    <span class="n">init_jvm</span><span class="p">()</span>
    <span class="n">can_read_meta_bf</span><span class="p">,</span> <span class="n">can_read_img_bf</span> <span class="o">=</span> <span class="n">check_to_use_bioformats</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
    <span class="n">can_use_bf</span> <span class="o">=</span> <span class="n">can_read_meta_bf</span> <span class="ow">and</span> <span class="n">can_read_img_bf</span>
    <span class="k">if</span> <span class="n">is_flattened_tiff</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">bf_reads_flat</span> <span class="o">=</span> <span class="n">check_flattened_pyramid_tiff</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">check_with_bf</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Give preference to BioFormatsSlideReader since it will be faster</span>
        <span class="k">if</span> <span class="n">bf_reads_flat</span> <span class="ow">and</span> <span class="n">can_read_img_bf</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BioFormatsSlideReader</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FlattenedPyramidReader</span>

    <span class="k">if</span> <span class="n">is_czi</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">can_read_img_bf</span><span class="p">:</span>
            <span class="c1"># Bio-formats should be able to read CZI</span>
            <span class="k">return</span> <span class="n">BioFormatsSlideReader</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Bio-formats unable to read CZI. Check if it is due to jpgxr compression</span>
            <span class="n">czi</span> <span class="o">=</span> <span class="n">CziFile</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
            <span class="n">comp_tree</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//OriginalCompressionMethod&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_tree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">is_czi_jpgxr</span> <span class="o">=</span> <span class="n">comp_tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;jpgxr&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_czi_jpgxr</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">is_czi_jpgxr</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CziJpgxrReader</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unable to find reader to open </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">src_f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>

                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">can_use_bf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BioFormatsSlideReader</span>

    <span class="c1"># Try using scikit-image. Not ideal if image is large</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ImageReader</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ImageReader</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unable to find reader to open </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">src_f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># Write slides to ome.tiff #</span>

<span class="k">def</span><span class="w"> </span><span class="nf">remove_control_chars</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove control characters</span>

<span class="sd">    Control characters shouldn&#39;t be in some strings, like channel names.</span>
<span class="sd">    This will remove them</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        String to check</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    control_char_removed : str</span>
<span class="sd">        `s` with control characters removed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">control_chars</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x20</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">))))</span>
    <span class="n">control_char_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">control_chars</span><span class="p">))</span>
    <span class="n">control_char_removed</span> <span class="o">=</span> <span class="n">control_char_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">control_char_removed</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_shape_xyzct</span><span class="p">(</span><span class="n">shape_wh</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get image shape in XYZCT format</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape_wh : tuple of int</span>
<span class="sd">        Width and heigth of image</span>

<span class="sd">    n_channels : int</span>
<span class="sd">        Number of channels in the image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xyzct : tuple of int</span>
<span class="sd">        XYZCT shape of the image</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">xyzct</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">shape_wh</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyzct</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_channel</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">samples_per_pixel</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an ome-xml channel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    channel_id : int</span>
<span class="sd">        Channel number</span>

<span class="sd">    name : str, optinal</span>
<span class="sd">        Channel name</span>

<span class="sd">    color : tuple of int</span>
<span class="sd">        Channel color</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_channel : ome_types.model.channel.Channel</span>
<span class="sd">        Channel object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unicode_name</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">decoded_name</span> <span class="o">=</span> <span class="n">unicode_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode_escape&#39;</span><span class="p">)</span>
        <span class="n">decoded_name</span> <span class="o">=</span> <span class="n">remove_control_chars</span><span class="p">(</span><span class="n">decoded_name</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">decoded_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">new_channel</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Channel:</span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_channel</span><span class="o">.</span><span class="n">samples_per_pixel</span> <span class="o">=</span> <span class="n">samples_per_pixel</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">decoded_name</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">new_channel</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="o">*</span><span class="n">color</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># color has alpha, won&#39;t be shown because it&#39;s 0</span>
                <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="o">*</span><span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">new_channel</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_channel</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_colormap</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">original_xml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span>
        <span class="n">channel_colors</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_matplotlib_channel_colors</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
        <span class="n">default_colormap</span> <span class="o">=</span> <span class="p">{</span><span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">channel_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)}</span>

        <span class="k">if</span> <span class="n">original_xml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to get original colors</span>
                <span class="n">og_ome</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">original_xml</span><span class="p">)</span>

                <span class="n">ome_img</span> <span class="o">=</span> <span class="n">og_ome</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">as_rgb_tuple</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span><span class="p">}</span>
                <span class="n">all_rgb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colormap</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ome_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_rgb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nc</span><span class="p">:</span>
                    <span class="c1"># Channels do not have unique colors</span>
                    <span class="n">colormap</span> <span class="o">=</span> <span class="n">default_colormap</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="c1"># Can&#39;t get original colors</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="n">default_colormap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">default_colormap</span>

    <span class="k">return</span> <span class="n">colormap</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make sure colormap is valid</span>
<span class="sd">    If colormap is a dictionary, make sure all `channel_names` are in keys of colormap.</span>
<span class="sd">    If colormap is a list, create a dictionary colormap</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    updated_colormap : dict</span>
<span class="sd">        Colormap dictionary or None if colormap was invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">updated_colormap</span> <span class="o">=</span> <span class="n">colormap</span>
    <span class="k">if</span> <span class="n">channel_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">colormap</span> <span class="o">==</span> <span class="n">CMAP_AUTO</span><span class="p">:</span>
        <span class="n">updated_colormap</span> <span class="o">=</span> <span class="n">get_colormap</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># colormap is an array for a single channel</span>
            <span class="n">updated_colormap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">updated_colormap</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated_colormap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not enough colors in colormap. Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">updated_colormap</span><span class="p">)</span><span class="si">}</span><span class="s2"> colors provided, but there are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels&quot;</span>
            <span class="n">updated_colormap</span> <span class="o">=</span> <span class="p">{</span><span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">updated_colormap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">))}</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>

        <span class="n">missing_channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">colormap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_channels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Missing colors in colormap for the following channels: </span><span class="si">{</span><span class="n">missing_channels</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">elif</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Colormap must be </span><span class="si">{</span><span class="n">CMAP_AUTO</span><span class="si">}</span><span class="s2">, &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;a list of colors with the same length as `channel_names`, &quot;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s2">&quot;a dictionary (key=channel name, value=rgb color), &quot;</span><span class="p">,</span>
               <span class="sa">f</span><span class="s2">&quot;or `None`&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;. Will not try to add channel colors&quot;</span>
        <span class="n">updated_colormap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">updated_colormap</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_default_channel_names</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">src_f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">src_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">default_channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">src_f</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default_channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">default_channel_names</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_channel_names</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">src_f</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">default_channel_names</span> <span class="o">=</span> <span class="n">get_default_channel_names</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">src_f</span><span class="o">=</span><span class="n">src_f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">channel_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">updated_channel_names</span> <span class="o">=</span> <span class="n">default_channel_names</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">updated_channel_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span>
                                 <span class="p">(</span><span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span>
                                 <span class="k">else</span> <span class="n">default_channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">)]</span>

    <span class="n">renamed_channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">updated_channel_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">channel_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">renamed_channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;some non-RGB channel names were `None` or not provided. Channels that got renamed are: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">renamed_channels</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">updated_channel_names</span>


<div class="viewcode-block" id="create_ome_xml">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.create_ome_xml">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_ome_xml</span><span class="p">(</span><span class="n">shape_xyzct</span><span class="p">,</span> <span class="n">bf_dtype</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">,</span> <span class="n">pixel_physical_size_xyu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">CMAP_AUTO</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create new ome-xmml object</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------</span>
<span class="sd">    shape_xyzct : tuple of int</span>
<span class="sd">        XYZCT shape of image</span>

<span class="sd">    bf_dtype : str</span>
<span class="sd">        String format of Bioformats datatype</span>

<span class="sd">    is_rgb : bool</span>
<span class="sd">        Whether or not the image is RGB</span>

<span class="sd">    pixel_physical_size_xyu : tuple, optional</span>
<span class="sd">        Physical size per pixel and the unit.</span>

<span class="sd">    channel_names : list, optional</span>
<span class="sd">        List of channel names.</span>

<span class="sd">    colormap : dict, str, optional</span>
<span class="sd">        Dictionary of channel colors, where the key is the channel name, and the value the color as rgb255.</span>
<span class="sd">        If &quot;auto&quot; (default), the channel colors from `current_ome_xml_str` will be used, if available.</span>
<span class="sd">        If `None`, channel colors will not be assigned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_ome : ome_types.model.OME</span>
<span class="sd">        ome_types.model.OME object containing ome-xml metadata</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Minimal ome-xml</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">shape_xyzct</span>
    <span class="n">new_ome</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">OME</span><span class="p">()</span>
    <span class="n">new_img</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Image:0&quot;</span><span class="p">,</span>
        <span class="n">pixels</span><span class="o">=</span><span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Pixels</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Pixels:0&quot;</span><span class="p">,</span>
            <span class="n">size_x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">size_y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
            <span class="n">size_z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
            <span class="n">size_c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">size_t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">bf_dtype</span><span class="p">,</span>
            <span class="n">dimension_order</span><span class="o">=</span><span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>
            <span class="n">metadata_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">pixel_physical_size_xyu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phys_x</span><span class="p">,</span> <span class="n">phys_y</span><span class="p">,</span> <span class="n">phys_u</span> <span class="o">=</span> <span class="n">pixel_physical_size_xyu</span>
        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_x</span> <span class="o">=</span> <span class="n">phys_x</span>
        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_x_unit</span> <span class="o">=</span> <span class="n">phys_u</span>
        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_y</span> <span class="o">=</span> <span class="n">phys_y</span>
        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">physical_size_y_unit</span> <span class="o">=</span> <span class="n">phys_u</span>

    <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="n">rgb_channel</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;Channel:0:0&#39;</span><span class="p">,</span> <span class="n">samples_per_pixel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">rgb_channel</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">updated_channel_names</span> <span class="o">=</span> <span class="n">check_channel_names</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">colormap</span> <span class="o">==</span> <span class="n">CMAP_AUTO</span><span class="p">:</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">get_colormap</span><span class="p">(</span><span class="n">updated_channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">check_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">updated_channel_names</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_channel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">updated_channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">[</span><span class="n">updated_channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_channel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">updated_channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colormap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mismatch between channel names and keys in colormap. Cannot find channel name </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> in colormap&quot;</span>
                <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, which has keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">colormap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;. Saving without colormap. To avoid this error, please provide valid colormap, or set colormap=None.&quot;</span>
                <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_channel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">updated_channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
                <span class="c1">#Mismatch between channel names and keys in colormap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_channel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">updated_channel_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>

        <span class="n">new_img</span><span class="o">.</span><span class="n">pixels</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>

    <span class="n">new_ome</span> <span class="o">=</span> <span class="n">ome_types</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">OME</span><span class="p">()</span>
    <span class="n">new_ome</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_img</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_ome</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_tile_wh</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">out_shape_wh</span><span class="p">,</span> <span class="n">default_wh</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get tile width and height to write image</span>
<span class="sd">    If predefined optimal tile wh is too large, will try to</span>
<span class="sd">    find the size that minimizes the overhangs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">default_wh</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">if</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">optimal_tile_wh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">default_wh</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">optimal_tile_wh</span>

    <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">down_sampling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">/</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">slide_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">tile_wh</span><span class="o">*</span><span class="n">down_sampling</span><span class="p">))</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">tile_wh</span> <span class="o">-</span> <span class="p">(</span><span class="n">tile_wh</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>  <span class="c1"># Tile shape must be multiple of 16</span>
        <span class="k">if</span> <span class="n">tile_wh</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">tile_wh</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_shape_wh</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tile_wh</span><span class="p">):</span>
        <span class="c1"># Tile is too big for the image. Get niggest tile size that fit in image</span>
        <span class="k">if</span> <span class="n">tile_wh</span> <span class="o">&lt;</span> <span class="n">default_wh</span><span class="p">:</span>
            <span class="n">min_wh</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_wh</span> <span class="o">=</span> <span class="n">default_wh</span>

        <span class="n">max_tile_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">out_shape_wh</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">max_tile_exp</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">min_wh</span><span class="p">):</span>
            <span class="n">min_wh</span> <span class="o">=</span> <span class="mi">16</span>

        <span class="n">possible_wh</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">min_wh</span><span class="p">),</span> <span class="n">max_tile_exp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">overhangs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">out_shape_wh</span><span class="o">/</span><span class="n">wh</span><span class="p">)</span><span class="o">*</span><span class="n">wh</span> <span class="o">-</span> <span class="n">out_shape_wh</span><span class="p">)</span> <span class="k">for</span> <span class="n">wh</span> <span class="ow">in</span> <span class="n">possible_wh</span><span class="p">])</span>
        <span class="n">min_overhang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">overhangs</span><span class="p">)</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">possible_wh</span><span class="p">[</span><span class="n">overhangs</span> <span class="o">==</span> <span class="n">min_overhang</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">tile_wh</span>


<div class="viewcode-block" id="update_xml_for_new_img">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.update_xml_for_new_img">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_xml_for_new_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">CMAP_AUTO</span><span class="p">,</span> <span class="n">pixel_physical_size_xyu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update dimensions ome-xml metadata</span>

<span class="sd">    Used to create a new ome-xmlthat reflects changes in an image, such as its shape</span>

<span class="sd">    If `current_ome_xml_str` is invalid or None, a new ome-xml will be created</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------</span>
<span class="sd">    img : ndarry or pyvips.Image</span>
<span class="sd">        Image for which xml will be generated. Used to determine shape and datatype.</span>

<span class="sd">    reader : SlideReader</span>
<span class="sd">        SlideReader used to open `img`. Will use this to extract other metadata, including</span>
<span class="sd">        the original xml.</span>

<span class="sd">    channel_names : list, optional</span>
<span class="sd">        List of channel names.</span>

<span class="sd">    colormap : dict, optional</span>
<span class="sd">        Dictionary of channel colors, where the key is the channel name, and the value the color as rgb255.</span>
<span class="sd">        If &quot;auto&quot; (the default), the channel colors from `current_ome_xml_str` will be used, if available.</span>
<span class="sd">        If None, and there are no channel colors in the `current_ome_xml_str`, then no colors will be added</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_ome : ome_types.model.OME</span>
<span class="sd">        ome_types.model.OME object containing ome-xml metadata</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">img_h</span><span class="p">,</span> <span class="n">img_w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">nc</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">n_channels</span>
    <span class="n">new_xyzct</span> <span class="o">=</span> <span class="n">get_shape_xyzct</span><span class="p">((</span><span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span><span class="p">),</span> <span class="n">nc</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">n_t</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">n_z</span><span class="p">)</span>
    <span class="n">current_ome_xml_str</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">original_xml</span>
    <span class="n">is_rgb</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">is_rgb</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">series</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
        <span class="n">bf_dtype</span> <span class="o">=</span> <span class="n">vips2bf_dtype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bf_dtype</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">NUMPY_FORMAT_BF_DTYPE</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">channel_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">channel_names</span>
    <span class="n">updated_channel_names</span> <span class="o">=</span> <span class="n">check_channel_names</span><span class="p">(</span><span class="n">channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pixel_physical_size_xyu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">pixel_physical_size_xyu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">PIXEL_UNIT</span><span class="p">:</span>
            <span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pixel_physical_size_xyu</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">scale_physical_size</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">colormap</span> <span class="o">==</span> <span class="n">CMAP_AUTO</span><span class="p">:</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">get_colormap</span><span class="p">(</span><span class="n">updated_channel_names</span><span class="p">,</span> <span class="n">is_rgb</span><span class="o">=</span><span class="n">is_rgb</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span> <span class="n">original_xml</span><span class="o">=</span><span class="n">current_ome_xml_str</span><span class="p">)</span>

        <span class="n">colormap</span> <span class="o">=</span> <span class="n">check_colormap</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="n">updated_channel_names</span><span class="p">)</span>

    <span class="n">og_valid_xml</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">og_ome</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">current_ome_xml_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">elementTree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">current_ome_xml_str</span><span class="p">)</span>
            <span class="n">og_ome</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">current_ome_xml_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">elementTree</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback_msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;xml in original file is invalid or missing. Will create one&quot;</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">traceback_msg</span><span class="o">=</span><span class="n">traceback_msg</span><span class="p">)</span>
            <span class="n">og_valid_xml</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">og_valid_xml</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">temp_new_ome</span> <span class="o">=</span> <span class="n">create_ome_xml</span><span class="p">(</span><span class="n">shape_xyzct</span><span class="o">=</span><span class="n">new_xyzct</span><span class="p">,</span> <span class="n">bf_dtype</span><span class="o">=</span><span class="n">bf_dtype</span><span class="p">,</span> <span class="n">is_rgb</span><span class="o">=</span><span class="n">is_rgb</span><span class="p">,</span>
                                  <span class="n">pixel_physical_size_xyu</span><span class="o">=</span><span class="n">pixel_physical_size_xyu</span><span class="p">,</span>
                                  <span class="n">channel_names</span><span class="o">=</span><span class="n">updated_channel_names</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">og_valid_xml</span> <span class="ow">and</span> <span class="n">og_ome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_ome</span> <span class="o">=</span> <span class="n">og_ome</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_ome</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">temp_new_ome</span><span class="o">.</span><span class="n">images</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_ome</span> <span class="o">=</span> <span class="n">temp_new_ome</span>

    <span class="k">return</span> <span class="n">new_ome</span></div>



<span class="nd">@valtils</span><span class="o">.</span><span class="n">deprecated_args</span><span class="p">(</span><span class="n">perceputally_uniform_channel_colors</span><span class="o">=</span><span class="s2">&quot;colormap&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">warp_and_save_slide</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">dst_f</span><span class="p">,</span> <span class="n">transformation_src_shape_rc</span><span class="p">,</span> <span class="n">transformation_dst_shape_rc</span><span class="p">,</span>
                        <span class="n">aligned_slide_shape_rc</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dxdy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_method</span><span class="o">=</span><span class="s2">&quot;bicubic&quot;</span><span class="p">,</span>
                        <span class="n">bbox_xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">tile_wh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">DEFAULT_COMPRESSION</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pyramid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; Warp and save a slide</span>

<span class="sd">    Warp slide according to `M` and/or `dxdy`, then save as an ome.tiff image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_f : str</span>
<span class="sd">        Path to slide</span>

<span class="sd">    dst_f : str</span>
<span class="sd">        Path indicating where the warped slide will be saved.</span>

<span class="sd">    transformation_src_shape_rc : (int, int)</span>
<span class="sd">        Shape of the image used to find the rigid transformations (row, col)</span>

<span class="sd">    transformation_dst_shape_rc : (int, int)</span>
<span class="sd">        Shape of image with shape `in_shape_rc`, after being warped,</span>
<span class="sd">        i.e. the shape of the registered image.</span>

<span class="sd">    aligned_slide_shape_rc : (int, int)</span>
<span class="sd">        Shape of the warped slide (row, col)</span>

<span class="sd">    M : ndarray, optional</span>
<span class="sd">        3x3 Affine transformation matrix to perform rigid warp.</span>
<span class="sd">        Found by aligning the target/fixed image to source/moving image.</span>
<span class="sd">        If `M` was found the other way around, then `M` will need to be inverted</span>
<span class="sd">        using np.linalg.inv()</span>

<span class="sd">    dxdy : list, optional</span>
<span class="sd">        A list containing the x-axis (column) displacement and y-axis (row) displacements.</span>
<span class="sd">        Found by aligning the target/fixed image to source/moving image.</span>
<span class="sd">        If `dxdy` was found the other way around, then `dxdy` will need to be inverted,</span>
<span class="sd">        which can be done using `warp_tools.get_inverse_field`</span>

<span class="sd">    level : int, optional</span>
<span class="sd">        Pyramid level to warp an save</span>

<span class="sd">    series : int, optional</span>
<span class="sd">        Series number of image</span>

<span class="sd">    interp_method : str, optional</span>
<span class="sd">        Interpolation method</span>

<span class="sd">    bbox_xywh : tuple</span>
<span class="sd">        Bounding box to crop warped slide. Should be in reference the</span>
<span class="sd">        warped slide.</span>

<span class="sd">    bg_color : optional, list</span>
<span class="sd">        Background color, if `None`, then the background color will be black</span>

<span class="sd">    colormap : dict, optional</span>
<span class="sd">        Dictionary of channel colors, where the key is the channel name, and the value the color as rgb255.</span>
<span class="sd">        If &quot;auto&quot; (default), the channel colors from `current_ome_xml_str` will be used, if available.</span>
<span class="sd">        If `None`, no channel colors will be added.</span>

<span class="sd">    tile_wh : int, optional</span>
<span class="sd">        Tile width and height used to save image</span>

<span class="sd">    compression : str</span>
<span class="sd">        Compression method used to save ome.tiff .</span>
<span class="sd">        be jpeg or jp2k. See https://libvips.github.io/pyvips/enums.html#pyvips.enums.ForeignTiffCompression for more details.</span>

<span class="sd">    Q : int</span>
<span class="sd">        Q factor for lossy compression</span>

<span class="sd">    pyramid : bool</span>
<span class="sd">        Whether or not to save an image pyramid.</span>

<span class="sd">    reader: SlideReader, optional</span>
<span class="sd">        Instantiated SlideReader to use to read image. If `None`,</span>
<span class="sd">        `get_slide_reader` will be used to find the appropriate reader.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">warped_slide</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">warp_slide</span><span class="p">(</span><span class="n">src_f</span><span class="o">=</span><span class="n">src_f</span><span class="p">,</span>
                                          <span class="n">transformation_src_shape_rc</span><span class="o">=</span><span class="n">transformation_src_shape_rc</span><span class="p">,</span>
                                          <span class="n">transformation_dst_shape_rc</span><span class="o">=</span><span class="n">transformation_dst_shape_rc</span><span class="p">,</span>
                                          <span class="n">aligned_slide_shape_rc</span><span class="o">=</span><span class="n">aligned_slide_shape_rc</span><span class="p">,</span>
                                          <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                                          <span class="n">dxdy</span><span class="o">=</span><span class="n">dxdy</span><span class="p">,</span>
                                          <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                          <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span>
                                          <span class="n">interp_method</span><span class="o">=</span><span class="n">interp_method</span><span class="p">,</span>
                                          <span class="n">bbox_xywh</span><span class="o">=</span><span class="n">bbox_xywh</span><span class="p">,</span>
                                          <span class="n">bg_color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span>
                                          <span class="n">reader</span><span class="o">=</span><span class="n">reader</span><span class="p">)</span>

    <span class="c1"># Get OMEXML and update with new dimensions</span>
    <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reader_cls</span> <span class="o">=</span> <span class="n">get_slide_reader</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span> <span class="c1"># Get slide reader class</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">reader_cls</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span> <span class="c1"># Get reader</span>

    <span class="n">ome_xml_obj</span> <span class="o">=</span> <span class="n">update_xml_for_new_img</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">warped_slide</span><span class="p">,</span>
                                         <span class="n">reader</span><span class="o">=</span><span class="n">reader</span><span class="p">,</span>
                                         <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                         <span class="n">channel_names</span><span class="o">=</span><span class="n">channel_names</span><span class="p">,</span>
                                         <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">)</span>

    <span class="n">ome_xml</span> <span class="o">=</span> <span class="n">ome_xml_obj</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>

    <span class="n">out_shape_wh</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(</span><span class="n">warped_slide</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">get_tile_wh</span><span class="p">(</span><span class="n">reader</span><span class="o">=</span><span class="n">reader</span><span class="p">,</span>
                          <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                          <span class="n">out_shape_wh</span><span class="o">=</span><span class="n">out_shape_wh</span><span class="p">)</span>

    <span class="n">save_ome_tiff</span><span class="p">(</span><span class="n">warped_slide</span><span class="p">,</span> <span class="n">dst_f</span><span class="o">=</span><span class="n">dst_f</span><span class="p">,</span> <span class="n">ome_xml</span><span class="o">=</span><span class="n">ome_xml</span><span class="p">,</span>
                  <span class="n">tile_wh</span><span class="o">=</span><span class="n">tile_wh</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">pyramid</span><span class="o">=</span><span class="n">pyramid</span><span class="p">)</span>


<div class="viewcode-block" id="save_ome_tiff">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.save_ome_tiff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_ome_tiff</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dst_f</span><span class="p">,</span> <span class="n">ome_xml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_wh</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">DEFAULT_COMPRESSION</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pyramid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save an image in the ome.tiff format using pyvips</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    img : pyvips.Image, ndarray</span>
<span class="sd">        Image to be saved. If a numpy array is provided, it will be converted</span>
<span class="sd">        to a pyvips.Image.</span>

<span class="sd">    ome_xml : str, optional</span>
<span class="sd">        ome-xml string describing image&#39;s metadata. If None, it will be created</span>

<span class="sd">    tile_wh : int</span>
<span class="sd">        Tile shape used to save `img`. Used to create a square tile, so `tile_wh`</span>
<span class="sd">        is both the width and height.</span>

<span class="sd">    compression : str</span>
<span class="sd">        Compression method used to save ome.tiff . See pyips for more details.</span>

<span class="sd">    Q : int</span>
<span class="sd">        Q factor for lossy compression</span>

<span class="sd">    pyramid : bool</span>
<span class="sd">        Whether or not to save an image pyramid.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dst_f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">vimage</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">numpy2vips</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">compression</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pyvips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">ForeignTiffCompression</span><span class="o">.</span><span class="n">JP2K</span><span class="p">,</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">ForeignTiffCompression</span><span class="o">.</span><span class="n">JPEG</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Image has type </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2"> but compression method </span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2"> will convert image to uint8. To avoid this, change compression &#39;lzw&#39;, &#39;deflate&#39;, or &#39;none&#39; &quot;</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compression</span> <span class="o">==</span> <span class="s2">&quot;jp2k&quot;</span><span class="p">:</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="s2">&quot;jpeg&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Float images can&#39;t be saved using </span><span class="si">{</span><span class="n">compression</span><span class="si">}</span><span class="s2"> compression. Please change to another method, such as &#39;lzw&#39;, &#39;deflate&#39;, or &#39;none&#39; &quot;</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">dst_f_extension</span> <span class="o">=</span> <span class="n">slide_tools</span><span class="o">.</span><span class="n">get_slide_extension</span><span class="p">(</span><span class="n">dst_f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dst_f_extension</span> <span class="o">!=</span> <span class="s2">&quot;.ome.tiff&quot;</span><span class="p">:</span>
        <span class="n">dst_dir</span><span class="p">,</span> <span class="n">out_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dst_f</span><span class="p">)</span>
        <span class="n">new_out_f</span> <span class="o">=</span> <span class="n">out_f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dst_f_extension</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.ome.tiff&quot;</span>
        <span class="n">new_dst_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">new_out_f</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_f</span><span class="si">}</span><span class="s2"> is not an ome.tiff. Changing dst_f to </span><span class="si">{</span><span class="n">new_dst_f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dst_f</span> <span class="o">=</span> <span class="n">new_dst_f</span>

    <span class="c1"># Get ome-xml metadata #</span>
    <span class="n">xyzct</span> <span class="o">=</span> <span class="n">get_shape_xyzct</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">bands</span><span class="p">)</span>

    <span class="n">og_interpretation</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">interpretation</span>
    <span class="n">is_rgb</span> <span class="o">=</span> <span class="n">og_interpretation</span> <span class="ow">in</span> <span class="n">VIPS_RGB_FORMATS</span>

    <span class="n">bf_dtype</span> <span class="o">=</span> <span class="n">vips2bf_dtype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ome_xml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create minimal ome-xml</span>
        <span class="n">ome_xml_obj</span> <span class="o">=</span> <span class="n">create_ome_xml</span><span class="p">(</span><span class="n">shape_xyzct</span><span class="o">=</span><span class="n">xyzct</span><span class="p">,</span> <span class="n">bf_dtype</span><span class="o">=</span><span class="n">bf_dtype</span><span class="p">,</span> <span class="n">is_rgb</span><span class="o">=</span><span class="n">is_rgb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Verify that vips image and ome-xml match</span>
        <span class="n">ome_xml_obj</span> <span class="o">=</span> <span class="n">get_ome_obj</span><span class="p">(</span><span class="n">ome_xml</span><span class="p">)</span>
        <span class="n">ome_img</span> <span class="o">=</span> <span class="n">ome_xml_obj</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pixels</span>
        <span class="n">total_pages</span> <span class="o">=</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_c</span><span class="o">*</span><span class="n">ome_img</span><span class="o">.</span><span class="n">size_z</span><span class="o">*</span><span class="n">ome_img</span><span class="o">.</span><span class="n">size_t</span>

        <span class="n">match_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;same_x&quot;</span><span class="p">:</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_x</span> <span class="o">==</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                      <span class="s2">&quot;same_y&quot;</span><span class="p">:</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">size_y</span> <span class="o">==</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                      <span class="s2">&quot;total_pages&quot;</span><span class="p">:</span> <span class="n">total_pages</span> <span class="o">==</span> <span class="n">img</span><span class="o">.</span><span class="n">bands</span><span class="p">,</span>
                      <span class="s2">&quot;same_type&quot;</span><span class="p">:</span> <span class="n">ome_img</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">bf_dtype</span>
                      <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">match_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mismatch in ome-xml and image: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">match_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">. Will create ome-xml&quot;</span>
            <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">ome_xml_obj</span> <span class="o">=</span> <span class="n">create_ome_xml</span><span class="p">(</span><span class="n">xyzct</span><span class="p">,</span> <span class="n">bf_dtype</span><span class="p">,</span> <span class="n">is_rgb</span><span class="p">)</span>

    <span class="n">ome_xml_obj</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pyvips version </span><span class="si">{</span><span class="n">pyvips</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ome_metadata</span> <span class="o">=</span> <span class="n">ome_xml_obj</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>

    <span class="c1"># Save ome-tiff using vips #</span>
    <span class="n">image_height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span>
    <span class="n">image_bands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">bands</span>
    <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="n">og_interpretation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">arrayjoin</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">bandsplit</span><span class="p">(),</span> <span class="n">across</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">interpretation</span><span class="o">=</span><span class="s2">&quot;b-w&quot;</span><span class="p">)</span>

    <span class="n">img</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">pyvips</span><span class="o">.</span><span class="n">GValue</span><span class="o">.</span><span class="n">gint_type</span><span class="p">,</span> <span class="s2">&quot;page-height&quot;</span><span class="p">,</span> <span class="n">image_height</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">pyvips</span><span class="o">.</span><span class="n">GValue</span><span class="o">.</span><span class="n">gstr_type</span><span class="p">,</span> <span class="s2">&quot;image-description&quot;</span><span class="p">,</span> <span class="n">ome_metadata</span><span class="p">)</span>

    <span class="c1"># Set up progress bar #</span>
    <span class="n">bar_len</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">is_rgb</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">image_bands</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">save_ome_tiff</span><span class="o">.</span><span class="n">n_complete</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">save_ome_tiff</span><span class="o">.</span><span class="n">current_im</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">eval_handler</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">save_ome_tiff</span><span class="o">.</span><span class="n">current_im</span> <span class="o">!=</span> <span class="n">progress</span><span class="o">.</span><span class="n">im</span><span class="p">:</span>
            <span class="n">save_ome_tiff</span><span class="o">.</span><span class="n">n_complete</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">save_ome_tiff</span><span class="o">.</span><span class="n">current_im</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">im</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">save_ome_tiff</span><span class="o">.</span><span class="n">n_complete</span><span class="o">*</span><span class="mi">100</span> <span class="o">+</span> <span class="n">progress</span><span class="o">.</span><span class="n">percent</span>
        <span class="n">filled_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bar_len</span> <span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
        <span class="n">percents</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="n">filled_len</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_len</span> <span class="o">-</span> <span class="n">filled_len</span><span class="p">)</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">processing_time_h</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">percents</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">processing_time_h</span><span class="p">,</span> <span class="s2">&quot;minutes&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">img</span><span class="o">.</span><span class="n">set_progress</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">signal_connect</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="n">eval_handler</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pyvips</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unable to create progress bar for pyvips. May need to update libvips to &gt;= 8.11&quot;</span>
        <span class="n">valtils</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;saving </span><span class="si">{</span><span class="n">dst_f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">image_height</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">image_bands</span><span class="si">}</span><span class="s2"> channels)&quot;</span><span class="p">)</span>

    <span class="c1"># Write image #</span>
    <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">tile_wh</span> <span class="o">-</span> <span class="p">(</span><span class="n">tile_wh</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>  <span class="c1"># Tile shape must be multiple of 16</span>

    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">xyzct</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tile_wh</span><span class="p">:</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyzct</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tile_wh</span><span class="p">):</span>
        <span class="c1"># Image is smaller than the tile #</span>
        <span class="n">min_dim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xyzct</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">min_dim</span> <span class="o">-</span> <span class="n">min_dim</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">tile_wh</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">lossless</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">==</span> <span class="mi">100</span>
    <span class="n">rgbjpeg</span> <span class="o">=</span> <span class="n">compression</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;jp2k&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">interpretation</span> <span class="ow">in</span> <span class="n">VIPS_RGB_FORMATS</span>
    <span class="n">subifd</span> <span class="o">=</span> <span class="n">pyramid</span> <span class="c1"># a pyramid will still be created if subifd = True and pyramid = False</span>
    <span class="n">img</span><span class="o">.</span><span class="n">tiffsave</span><span class="p">(</span><span class="n">dst_f</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="n">tile</span><span class="p">,</span>
                 <span class="n">tile_width</span><span class="o">=</span><span class="n">tile_wh</span><span class="p">,</span> <span class="n">tile_height</span><span class="o">=</span><span class="n">tile_wh</span><span class="p">,</span>
                 <span class="n">pyramid</span><span class="o">=</span><span class="n">pyramid</span><span class="p">,</span> <span class="n">subifd</span><span class="o">=</span><span class="n">subifd</span><span class="p">,</span> <span class="n">bigtiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">lossless</span><span class="o">=</span><span class="n">lossless</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">rgbjpeg</span><span class="o">=</span><span class="n">rgbjpeg</span><span class="p">)</span>

    <span class="c1"># Print total time to completion #</span>
    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">processing_time_seconds</span> <span class="o">=</span> <span class="n">toc</span><span class="o">-</span><span class="n">tic</span>
    <span class="n">processing_time</span><span class="p">,</span> <span class="n">processing_time_unit</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">get_elapsed_time_string</span><span class="p">(</span><span class="n">processing_time_seconds</span><span class="p">)</span>

    <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="n">bar_len</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">processing_time</span><span class="p">,</span> <span class="n">processing_time_unit</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Complete</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="convert_to_ome_tiff">
<a class="viewcode-back" href="../../slide_io.html#valis.slide_io.convert_to_ome_tiff">[docs]</a>
<span class="nd">@valtils</span><span class="o">.</span><span class="n">deprecated_args</span><span class="p">(</span><span class="n">perceputally_uniform_channel_colors</span><span class="o">=</span><span class="s2">&quot;colormap&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_to_ome_tiff</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">dst_f</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">colormap</span><span class="o">=</span><span class="n">CMAP_AUTO</span><span class="p">,</span> <span class="n">tile_wh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">DEFAULT_COMPRESSION</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pyramid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an image to an ome.tiff image</span>

<span class="sd">    Saves a new copy of the image as a tiled pyramid ome.tiff with valid ome-xml.</span>
<span class="sd">    Uses pyvips to save the image. Currently only writes a single series.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src_f : str</span>
<span class="sd">        Path to image to be converted</span>

<span class="sd">    dst_f : str</span>
<span class="sd">        Path indicating where the image should be saved.</span>

<span class="sd">    level : int</span>
<span class="sd">        Pyramid level to be converted.</span>

<span class="sd">    series : str</span>
<span class="sd">        Series to be converted.</span>

<span class="sd">    xywh : tuple of int, optional</span>
<span class="sd">        The region of the slide to be converted. If None,</span>
<span class="sd">        then the entire slide will be converted. Otherwise</span>
<span class="sd">        xywh is the (top left x, top left y, width, height) of</span>
<span class="sd">        the region to be sliced.</span>

<span class="sd">    colormap : dict, optional</span>
<span class="sd">        Dictionary of channel colors, where the key is the channel name, and the value the color as rgb255.</span>
<span class="sd">        If None (default), the channel colors from `current_ome_xml_str` will be used, if available.</span>
<span class="sd">        If None, and there are no channel colors in the `current_ome_xml_str`, then no colors will be added</span>

<span class="sd">    tile_wh : int</span>
<span class="sd">        Tile shape used to save the image. Used to create a square tile,</span>
<span class="sd">        so `tile_wh` is both the width and height.</span>

<span class="sd">    compression : str</span>
<span class="sd">        Compression method used to save ome.tiff. See pyips for more details.</span>

<span class="sd">    Q : int</span>
<span class="sd">        Q factor for lossy compression</span>

<span class="sd">    pyramid : bool</span>
<span class="sd">        Whether or not to save an image pyramid.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reader_cls</span> <span class="o">=</span> <span class="n">get_slide_reader</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">reader_cls</span><span class="p">(</span><span class="n">src_f</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
    <span class="n">slide_meta</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">metadata</span>
    <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">series</span>

    <span class="n">vips_img</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">slide2vips</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">,</span> <span class="n">xywh</span><span class="o">=</span><span class="n">xywh</span><span class="p">)</span>

    <span class="n">ome_obj</span> <span class="o">=</span> <span class="n">update_xml_for_new_img</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">vips_img</span><span class="p">,</span>
                                     <span class="n">reader</span><span class="o">=</span><span class="n">reader</span><span class="p">,</span>
                                     <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                     <span class="n">channel_names</span><span class="o">=</span><span class="n">slide_meta</span><span class="o">.</span><span class="n">channel_names</span><span class="p">,</span>
                                     <span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">)</span>

    <span class="n">ome_obj</span><span class="o">.</span><span class="n">creator</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pyvips version </span><span class="si">{</span><span class="n">pyvips</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ome_xml_str</span> <span class="o">=</span> <span class="n">ome_obj</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tile_wh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">slide_meta</span><span class="o">.</span><span class="n">optimal_tile_wh</span>

    <span class="k">if</span> <span class="n">tile_wh</span> <span class="o">&gt;</span> <span class="n">MAX_TILE_SIZE</span><span class="p">:</span>
        <span class="n">tile_wh</span> <span class="o">=</span> <span class="n">MAX_TILE_SIZE</span>

    <span class="n">save_ome_tiff</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">vips_img</span><span class="p">,</span> <span class="n">dst_f</span><span class="o">=</span><span class="n">dst_f</span><span class="p">,</span> <span class="n">ome_xml</span><span class="o">=</span><span class="n">ome_xml_str</span><span class="p">,</span> <span class="n">tile_wh</span><span class="o">=</span><span class="n">tile_wh</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span> <span class="n">pyramid</span><span class="o">=</span><span class="n">pyramid</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2025, Chandler Gatenbee.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>